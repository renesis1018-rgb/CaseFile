import SwiftUI
import CoreData
import AppKit

struct BeforeAfterComparisonView: View {
    let photos: [Photo]
    @Environment(\.dismiss) private var dismiss
    
    @State private var selectedAngle = "Ê≠£Èù¢"
    @State private var selectedTimings: [String] = []
    @State private var sliderValue: Double = 0
    @State private var availableTimings: [String] = []
    @State private var syncZoom = true
    @State private var zoomScale: CGFloat = 1.0
    
    let angles = ["Ê≠£Èù¢", "Âè≥ÂÅ¥Èù¢", "Â∑¶ÂÅ¥Èù¢", "Âè≥Êñú„ÇÅ", "Â∑¶Êñú„ÇÅ", "„Åù„ÅÆ‰ªñ"]
    
    var filteredPhotos: [String: Photo] {
        var result: [String: Photo] = [:]
        
        for timing in selectedTimings {
            if let photo = photos.first(where: { 
                $0.angle == selectedAngle && $0.timing == timing 
            }) {
                result[timing] = photo
            }
        }
        
        return result
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // „Éò„ÉÉ„ÉÄ„Éº
            HStack {
                Text("üìä Before/After ÊØîËºÉ")
                    .font(.title2)
                    .fontWeight(.bold)
                
                Spacer()
                
                // ÂêåÊúü„Ç∫„Éº„É†
                Toggle("„Ç∫„Éº„É†ÂêåÊúü", isOn: $syncZoom)
                    .toggleStyle(.switch)
                
                Button("Èñâ„Åò„Çã") {
                    dismiss()
                }
            }
            .padding()
            
            Divider()
            
            if availableTimings.isEmpty {
                VStack(spacing: 20) {
                    Image(systemName: "photo.on.rectangle.angled")
                        .font(.system(size: 60))
                        .foregroundColor(.gray)
                    Text("ÈÅ∏Êäû„Åó„ÅüËßíÂ∫¶„ÅÆÂÜôÁúü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")
                        .font(.headline)
                        .foregroundColor(.secondary)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                // „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´
                VStack(spacing: 15) {
                    // ËßíÂ∫¶ÈÅ∏Êäû
                    HStack {
                        Text("ËßíÂ∫¶:")
                            .fontWeight(.semibold)
                        
                        Picker("ËßíÂ∫¶", selection: $selectedAngle) {
                            ForEach(angles, id: \.self) { angle in
                                Text(angle).tag(angle)
                            }
                        }
                        .pickerStyle(.segmented)
                        .onChange(of: selectedAngle) { _ in
                            updateAvailableTimings()
                        }
                        
                        Spacer()
                    }
                    
                    // Ë°®Á§∫ÊôÇÊúüÈÅ∏Êäû
                    if selectedTimings.count >= 3 {
                        HStack {
                            Text("ÊØîËºÉ:")
                                .fontWeight(.semibold)
                            
                            // ÊôÇÊúü1
                            Picker("ÊôÇÊúü1", selection: $selectedTimings[0]) {
                                ForEach(availableTimings, id: \.self) { timing in
                                    Text(timing).tag(timing)
                                }
                            }
                            .frame(width: 120)
                            
                            Text("vs")
                                .foregroundColor(.secondary)
                            
                            // ÊôÇÊúü2
                            Picker("ÊôÇÊúü2", selection: $selectedTimings[1]) {
                                ForEach(availableTimings, id: \.self) { timing in
                                    Text(timing).tag(timing)
                                }
                            }
                            .frame(width: 120)
                            
                            Text("vs")
                                .foregroundColor(.secondary)
                            
                            // ÊôÇÊúü3
                            Picker("ÊôÇÊúü3", selection: $selectedTimings[2]) {
                                ForEach(availableTimings, id: \.self) { timing in
                                    Text(timing).tag(timing)
                                }
                            }
                            .frame(width: 120)
                            
                            Spacer()
                        }
                    }
                    
                    // „Çø„Ç§„É†„É©„Ç§„É≥„Çπ„É©„Ç§„ÉÄ„Éº
                    if availableTimings.count > 1 {
                        VStack(alignment: .leading, spacing: 5) {
                            HStack {
                                Text("„Çø„Ç§„É†„É©„Ç§„É≥:")
                                    .fontWeight(.semibold)
                                
                                Text(getTimingFromSlider())
                                    .foregroundColor(.blue)
                                    .fontWeight(.bold)
                            }
                            
                            HStack {
                                Text("Ë°ìÂâç")
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                                
                                Slider(value: $sliderValue, in: 0...Double(max(availableTimings.count - 1, 0)), step: 1)
                                    .onChange(of: sliderValue) { _ in
                                        updateTimingFromSlider()
                                    }
                                
                                Text("ÊúÄÊñ∞")
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }
                            
                            // „Çø„Ç§„É†„É©„Ç§„É≥„Éû„Éº„Ç´„Éº
                            HStack {
                                ForEach(Array(availableTimings.enumerated()), id: \.offset) { index, timing in
                                    VStack {
                                        Circle()
                                            .fill(Int(sliderValue) == index ? Color.blue : Color.gray)
                                            .frame(width: 8, height: 8)
                                        Text(timing)
                                            .font(.caption2)
                                            .foregroundColor(Int(sliderValue) == index ? .blue : .secondary)
                                    }
                                    .frame(maxWidth: .infinity)
                                }
                            }
                            .padding(.horizontal)
                        }
                    }
                    
                    // „Ç∫„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´
                    HStack {
                        Text("„Ç∫„Éº„É†:")
                            .fontWeight(.semibold)
                        
                        Button(action: { zoomOut() }) {
                            Image(systemName: "minus.magnifyingglass")
                        }
                        .disabled(zoomScale <= 0.5)
                        
                        Text("\(Int(zoomScale * 100))%")
                            .frame(width: 60)
                        
                        Button(action: { zoomIn() }) {
                            Image(systemName: "plus.magnifyingglass")
                        }
                        .disabled(zoomScale >= 3.0)
                        
                        Button("„É™„Çª„ÉÉ„Éà") {
                            zoomScale = 1.0
                        }
                        .disabled(zoomScale == 1.0)
                        
                        Spacer()
                    }
                    .buttonStyle(.bordered)
                }
                .padding()
                .background(Color(NSColor.controlBackgroundColor))
                
                Divider()
                
                // ÂÜôÁúüÊØîËºÉ„Ç®„É™„Ç¢
                ScrollView([.horizontal, .vertical], showsIndicators: true) {
                    HStack(spacing: 20) {
                        ForEach(selectedTimings, id: \.self) { timing in
                            ComparisonPhotoCard(
                                photo: filteredPhotos[timing],
                                timing: timing,
                                zoomScale: zoomScale
                            )
                        }
                    }
                    .padding()
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            }
        }
        .frame(width: 1200, height: 800)
        .onAppear {
            updateAvailableTimings()
        }
    }
    
    // MARK: - Functions
    
    private func updateAvailableTimings() {
        // ÈÅ∏Êäû„Åï„Çå„ÅüËßíÂ∫¶„ÅßÂà©Áî®ÂèØËÉΩ„Å™ÊôÇÊúü„ÇíÂèñÂæó
        let timingsForAngle = photos
            .filter { $0.angle == selectedAngle }
            .compactMap { $0.timing }
        
        // ÈáçË§á„ÇíÂâäÈô§„Åó„Å¶ÊôÇÊúüÈ†Ü„Å´„ÇΩ„Éº„Éà
        let uniqueTimings = Array(Set(timingsForAngle)).sorted { timing1, timing2 in
            timingOrder(timing1) < timingOrder(timing2)
        }
        
        availableTimings = uniqueTimings
        
        // ÂàùÊúüÈÅ∏ÊäûÊôÇÊúü„ÇíË®≠ÂÆö
        if selectedTimings.isEmpty || selectedTimings.count < 3 {
            selectedTimings = Array(repeating: availableTimings.first ?? "Ë°ìÂâç", count: 3)
            
            if availableTimings.count >= 1 {
                selectedTimings[0] = availableTimings[0]
            }
            if availableTimings.count >= 2 {
                selectedTimings[1] = availableTimings[min(1, availableTimings.count - 1)]
            }
            if availableTimings.count >= 3 {
                selectedTimings[2] = availableTimings[min(2, availableTimings.count - 1)]
            }
        } else {
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
            for i in selectedTimings.indices {
                if !availableTimings.contains(selectedTimings[i]) {
                    if i < availableTimings.count {
                        selectedTimings[i] = availableTimings[i]
                    } else {
                        selectedTimings[i] = availableTimings.last ?? "Ë°ìÂâç"
                    }
                }
            }
        }
        
        // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂàùÊúüÂÄ§„ÇíË®≠ÂÆö
        sliderValue = 0
    }
    
    private func getTimingFromSlider() -> String {
        let index = Int(sliderValue)
        return availableTimings.indices.contains(index) ? availableTimings[index] : (availableTimings.first ?? "Ë°ìÂâç")
    }
    
    private func updateTimingFromSlider() {
        let timing = getTimingFromSlider()
        // „Çπ„É©„Ç§„ÉÄ„Éº„ÅßÈÅ∏Êäû„Åó„ÅüÊôÇÊúü„Çí2Áï™ÁõÆ„ÅÆ‰ΩçÁΩÆ„Å´Ë®≠ÂÆö
        if selectedTimings.count > 1 {
            selectedTimings[1] = timing
        }
    }
    
    private func zoomIn() {
        withAnimation {
            zoomScale = min(zoomScale + 0.25, 3.0)
        }
    }
    
    private func zoomOut() {
        withAnimation {
            zoomScale = max(zoomScale - 0.25, 0.5)
        }
    }
    
    private func timingOrder(_ timing: String) -> Int {
        switch timing {
        case "Ë°ìÂâç": return 0
        case "1W": return 1
        case "1M": return 2
        case "3M": return 3
        case "6M": return 4
        case "12M": return 5
        default:
            if timing.starts(with: "Day ") {
                let dayString = timing.replacingOccurrences(of: "Day ", with: "")
                if let days = Int(dayString) {
                    return 100 + days
                }
            }
            return 999
        }
    }
}

// MARK: - ComparisonPhotoCard

struct ComparisonPhotoCard: View {
    let photo: Photo?
    let timing: String
    let zoomScale: CGFloat
    
    var body: some View {
        VStack(spacing: 10) {
            // „Éò„ÉÉ„ÉÄ„Éº
            Text(timing)
                .font(.headline)
                .foregroundColor(.primary)
                .frame(maxWidth: .infinity)
                .padding(8)
                .background(Color.blue.opacity(0.1))
                .cornerRadius(8)
            
            // ÂÜôÁúü
            if let photo = photo,
               let imageData = photo.imageData,
               let nsImage = NSImage(data: imageData),
               let cgImage = nsImage.cgImage(forProposedRect: nil, context: nil, hints: nil) {
                
                Image(decorative: cgImage, scale: 1.0)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 350, height: 350)
                    .scaleEffect(zoomScale)
                    .clipShape(RoundedRectangle(cornerRadius: 12))
                    .overlay(
                        RoundedRectangle(cornerRadius: 12)
                            .stroke(Color.blue, lineWidth: 2)
                    )
                    .shadow(radius: 5)
                    .onDrag {
                        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Ç≥„Éî„Éº
                        return createDragItem(imageData: imageData, photo: photo)
                    }
                
                // „É°„ÇøÊÉÖÂ†±
                VStack(alignment: .leading, spacing: 5) {
                    if let exifDate = photo.exifDate {
                        HStack {
                            Image(systemName: "calendar")
                                .foregroundColor(.secondary)
                            Text("ÊíÆÂΩ±: \(formatDate(exifDate))")
                                .font(.caption)
                        }
                    }
                    
                    if photo.daysAfterSurgery >= 0 {
                        HStack {
                            Image(systemName: "clock")
                                .foregroundColor(.secondary)
                            Text("Ë°ìÂæå \(photo.daysAfterSurgery)Êó•")
                                .font(.caption)
                        }
                    }
                }
                .frame(maxWidth: 350, alignment: .leading)
                .padding(.horizontal)
                
            } else {
                // ÂÜôÁúü„Å™„Åó
                VStack {
                    Image(systemName: "photo.fill")
                        .font(.system(size: 60))
                        .foregroundColor(.gray.opacity(0.3))
                    
                    Text("ÂÜôÁúü„Å™„Åó")
                        .foregroundColor(.secondary)
                }
                .frame(width: 350, height: 350)
                .background(Color.gray.opacity(0.1))
                .clipShape(RoundedRectangle(cornerRadius: 12))
            }
        }
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .short
        formatter.locale = Locale(identifier: "ja_JP")
        return formatter.string(from: date)
    }
    
    private func createDragItem(imageData: Data, photo: Photo) -> NSItemProvider {
        let timing = photo.timing ?? "unknown"
        let angle = photo.angle ?? "unknown"
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyyMMdd_HHmmss"
        let dateString = photo.exifDate.map { dateFormatter.string(from: $0) } ?? "nodate"
        
        let fileName = "photo_\(timing)_\(angle)_\(dateString).jpg"
        let tempURL = FileManager.default.temporaryDirectory.appendingPathComponent(fileName)
        
        do {
            try imageData.write(to: tempURL)
            return NSItemProvider(contentsOf: tempURL)!
        } catch {
            print("‚ùå „Éâ„É©„ÉÉ„Ç∞„Ç¢„Ç§„ÉÜ„É†‰ΩúÊàê„Ç®„É©„Éº: \(error)")
            return NSItemProvider()
        }
    }
}
