import SwiftUI
import CoreData
import AppKit

struct PhotoUploadView: View {
    let surgery: Surgery
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var selectedImages: [UploadImage] = []
    @State private var isProcessing = false
    @State private var showToast = false
    @State private var toastMessage = ""
    
    // „Éâ„É©„ÉÉ„Ç∞ÈÅ∏ÊäûÁî®
    @State private var selectionStart: Int? = nil
    @State private var currentAngle = "Ê≠£Èù¢"
    
    var body: some View {
        VStack(spacing: 0) {
            // „Éò„ÉÉ„ÉÄ„Éº
            HStack {
                Text("üì∏ ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("„Ç≠„É£„É≥„Çª„É´") {
                    dismiss()
                }
            }
            .padding()
            
            Divider()
            
            if selectedImages.isEmpty {
                // ÂÜôÁúüÈÅ∏Êäû„Ç®„É™„Ç¢
                VStack(spacing: 20) {
                    Image(systemName: "photo.on.rectangle.angled")
                        .font(.system(size: 80))
                        .foregroundColor(.gray)
                    
                    Text("ÂÜôÁúü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
                        .font(.headline)
                    
                    Text("‰∏ÄÂ∫¶„Å´ÊúÄÂ§ß40Êûö„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Button("ÂÜôÁúü„ÇíÈÅ∏Êäû") {
                        selectPhotos()
                    }
                    .buttonStyle(.borderedProminent)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                // ÂÜôÁúü„Éó„É¨„Éì„É•„Éº + ËßíÂ∫¶Ë®≠ÂÆö„Ç®„É™„Ç¢
                VStack(spacing: 15) {
                    // ËßíÂ∫¶ÈÅ∏Êäû + ÊÉÖÂ†±
                    HStack {
                        Text("ËßíÂ∫¶Ë®≠ÂÆö:")
                            .fontWeight(.semibold)
                        
                        Picker("ËßíÂ∫¶", selection: $currentAngle) {
                            Text("Ê≠£Èù¢").tag("Ê≠£Èù¢")
                            Text("Âè≥ÂÅ¥Èù¢").tag("Âè≥ÂÅ¥Èù¢")
                            Text("Â∑¶ÂÅ¥Èù¢").tag("Â∑¶ÂÅ¥Èù¢")
                            Text("Âè≥Êñú„ÇÅ").tag("Âè≥Êñú„ÇÅ")
                            Text("Â∑¶Êñú„ÇÅ").tag("Â∑¶Êñú„ÇÅ")
                            Text("„Åù„ÅÆ‰ªñ").tag("„Åù„ÅÆ‰ªñ")
                        }
                        .pickerStyle(.segmented)
                        .frame(maxWidth: 500)
                        
                        Spacer()
                        
                        Text("\(selectedImages.count)ÊûöÈÅ∏Êäû‰∏≠")
                            .foregroundColor(.secondary)
                        
                        Button("‰∏ÄÊã¨Ë®≠ÂÆö") {
                            applyAngleToAll()
                        }
                        .buttonStyle(.bordered)
                    }
                    .padding(.horizontal)
                    
                    // „Éâ„É©„ÉÉ„Ç∞ÈÅ∏Êäû„ÅÆË™¨Êòé
                    HStack {
                        Image(systemName: "info.circle")
                            .foregroundColor(.blue)
                        Text("Shift„Ç≠„Éº„ÇíÊäº„Åó„Å™„Åå„Çâ„ÇØ„É™„ÉÉ„ÇØ„ÅßÁØÑÂõ≤ÈÅ∏Êäû ‚Üí ËßíÂ∫¶„Çí‰∏ÄÊã¨Ë®≠ÂÆö„Åß„Åç„Åæ„Åô")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    .padding(.horizontal)
                    
                    // „Çµ„É†„Éç„Ç§„É´„Ç∞„É™„ÉÉ„Éâ
                    ScrollView {
                        LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 10), count: 5), spacing: 10) {
                            ForEach(Array(selectedImages.enumerated()), id: \.offset) { index, image in
                                PhotoThumbnailCell(
                                    image: image,
                                    index: index,
                                    isSelected: image.isSelected,
                                    onTap: {
                                        handleTap(index: index)
                                    }
                                )
                            }
                        }
                        .padding()
                    }
                    
                    Divider()
                    
                    // „Ç¢„ÇØ„Ç∑„Éß„É≥
                    HStack {
                        Button("ÂÜôÁúü„ÇíËøΩÂä†ÈÅ∏Êäû") {
                            selectPhotos()
                        }
                        .buttonStyle(.bordered)
                        
                        Spacer()
                        
                        Button("ÈÅ∏Êäû‰∏≠„ÅÆÂÜôÁúü„Å´ËßíÂ∫¶„ÇíË®≠ÂÆö") {
                            applyAngleToSelected()
                        }
                        .disabled(selectedImages.filter(\.isSelected).isEmpty)
                        .buttonStyle(.borderedProminent)
                        
                        Button("‰øùÂ≠ò") {
                            savePhotos()
                        }
                        .disabled(isProcessing)
                        .buttonStyle(.borderedProminent)
                    }
                    .padding()
                }
            }
        }
        .frame(width: 900, height: 700)
        .overlay(
            Group {
                if showToast {
                    ToastView(message: toastMessage)
                        .transition(.move(edge: .top).combined(with: .opacity))
                }
            },
            alignment: .top
        )
    }
    
    // MARK: - Functions
    
    private func selectPhotos() {
        let panel = NSOpenPanel()
        panel.allowsMultipleSelection = true
        panel.canChooseDirectories = false
        panel.canChooseFiles = true
        panel.allowedContentTypes = [.image]
        
        if panel.runModal() == .OK {
            let urls = panel.urls
            for url in urls {
                if let imageData = try? Data(contentsOf: url),
                   let nsImage = NSImage(data: imageData) {
                    
                    var timing = "Ë°ìÂâç"
                    var daysAfter: Int = 0
                    var exifDate: Date? = nil
                    
                    // EXIFÊó•‰ªò„ÇíÊäΩÂá∫
                    if let extractedDate = PhotoManager.shared.extractEXIFDate(from: imageData) {
                        exifDate = extractedDate
                        
                        // ÊâãË°ìÊó•„Å®„ÅÆÁµåÈÅéÊó•Êï∞„ÇíË®àÁÆó
                        if let surgeryDate = surgery.date {
                            daysAfter = PhotoManager.shared.calculateDaysAfterSurgery(
                                surgeryDate: surgeryDate,
                                photoDate: extractedDate
                            )
                            
                            // ÊôÇÊúü„ÇíÊé®ÂÆö
                            timing = PhotoManager.shared.estimateTiming(from: daysAfter)
                        }
                    }
                    
                    let uploadImage = UploadImage(
                        nsImage: nsImage,
                        imageData: imageData,
                        angle: currentAngle,
                        timing: timing,
                        exifDate: exifDate,
                        daysAfterSurgery: daysAfter
                    )
                    
                    selectedImages.append(uploadImage)
                }
            }
            
            showToastMessage("üì∏ \(urls.count)Êûö„ÅÆÂÜôÁúü„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü")
        }
    }
    
    private func handleTap(index: Int) {
        let isShiftPressed = NSEvent.modifierFlags.contains(.shift)
        
        if isShiftPressed {
            // Shift+„ÇØ„É™„ÉÉ„ÇØ: ÁØÑÂõ≤ÈÅ∏Êäû
            if let start = selectionStart {
                let range = min(start, index)...max(start, index)
                for i in range {
                    selectedImages[i].isSelected = true
                }
                selectionStart = nil
            } else {
                selectionStart = index
                selectedImages[index].isSelected.toggle()
            }
        } else {
            // ÈÄöÂ∏∏„ÇØ„É™„ÉÉ„ÇØ: Âçò‰∏ÄÈÅ∏Êäû„Éà„Ç∞„É´
            selectedImages[index].isSelected.toggle()
            selectionStart = index
        }
    }
    
    private func applyAngleToSelected() {
        for i in selectedImages.indices {
            if selectedImages[i].isSelected {
                selectedImages[i].angle = currentAngle
                selectedImages[i].isSelected = false
            }
        }
        selectionStart = nil
        showToastMessage("‚úÖ ÈÅ∏Êäû„Åó„ÅüÂÜôÁúü„Å´„Äå\(currentAngle)„Äç„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü")
    }
    
    private func applyAngleToAll() {
        for i in selectedImages.indices {
            selectedImages[i].angle = currentAngle
        }
        showToastMessage("‚úÖ ÂÖ®„Å¶„ÅÆÂÜôÁúü„Å´„Äå\(currentAngle)„Äç„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü")
    }
    
    private func savePhotos() {
        isProcessing = true
        
        for image in selectedImages {
            PhotoManager.shared.savePhoto(
                context: viewContext,
                surgery: surgery,
                imageData: image.imageData,
                angle: image.angle,
                notes: nil,
                surgeryDate: surgery.date ?? Date()
            )
        }
        
        isProcessing = false
        showToastMessage("‚úÖ \(selectedImages.count)Êûö„ÅÆÂÜôÁúü„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü")
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
            dismiss()
        }
    }
    
    private func showToastMessage(_ message: String) {
        toastMessage = message
        withAnimation {
            showToast = true
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            withAnimation {
                showToast = false
            }
        }
    }
}

// MARK: - UploadImage Model

struct UploadImage: Identifiable {
    let id = UUID()
    let nsImage: NSImage
    let imageData: Data
    var angle: String
    var timing: String
    var exifDate: Date?
    var daysAfterSurgery: Int
    var notes: String?
    var isSelected: Bool = false
}

// MARK: - PhotoThumbnailCell

struct PhotoThumbnailCell: View {
    let image: UploadImage
    let index: Int
    let isSelected: Bool
    let onTap: () -> Void
    
    var body: some View {
        VStack(spacing: 5) {
            ZStack(alignment: .topLeading) {
                if let cgImage = image.nsImage.cgImage(forProposedRect: nil, context: nil, hints: nil) {
                    Image(decorative: cgImage, scale: 1.0)
                        .resizable()
                        .scaledToFill()
                        .frame(width: 150, height: 150)
                        .clipShape(RoundedRectangle(cornerRadius: 8))
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(isSelected ? Color.blue : Color.gray.opacity(0.3), lineWidth: isSelected ? 3 : 1)
                        )
                }
                
                // ÈÅ∏Êäû„Éû„Éº„ÇØ
                if isSelected {
                    Image(systemName: "checkmark.circle.fill")
                        .foregroundColor(.blue)
                        .background(Color.white.clipShape(Circle()))
                        .padding(5)
                }
            }
            .onTapGesture {
                onTap()
            }
            
            // ËßíÂ∫¶
            Text(image.angle)
                .font(.caption)
                .fontWeight(.semibold)
                .foregroundColor(.blue)
            
            // ÊôÇÊúü
            Text(image.timing)
                .font(.caption2)
                .foregroundColor(.secondary)
        }
    }
}
