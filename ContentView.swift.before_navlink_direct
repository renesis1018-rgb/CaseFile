import SwiftUI
import CoreData

struct ContentView: View {
    @Environment(\.managedObjectContext) private var viewContext
    
    @FetchRequest(
        sortDescriptors: [NSSortDescriptor(keyPath: \Patient.registeredDate, ascending: false)],
        animation: .default)
    private var patients: FetchedResults<Patient>
    
    @State private var searchText = ""
    @State private var showAddPatient = false
    @State private var selectedSortOption: SortOption = .registeredDate
    @State private var showAdvancedSearch = false
    @State private var filterCategory: String? = nil
    @State private var filterType: String? = nil
    
    enum SortOption: String, CaseIterable, Identifiable {
        case registeredDate = "ç™»éŒ²æ—¥"
        case patientId = "æ‚£è€…ID"
        case age = "å¹´é½¢"
        
        var id: String { rawValue }
    }
    
    var filteredPatients: [Patient] {
        var result = patients.filter { patient in
            if searchText.isEmpty {
                return true
            }
            return patient.patientId?.localizedCaseInsensitiveContains(searchText) ?? false
        }
        
        // è¡“å¼ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿
        if let category = filterCategory {
            result = result.filter { patient in
                patient.surgeries?.contains(where: { surgery in
                    (surgery as? Surgery)?.surgeryCategory == category
                }) ?? false
            }
        }
        
        // è¡“å¼ã‚¿ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿
        if let type = filterType {
            result = result.filter { patient in
                patient.surgeries?.contains(where: { surgery in
                    (surgery as? Surgery)?.surgeryType == type
                }) ?? false
            }
        }
        
        // ã‚½ãƒ¼ãƒˆ
        switch selectedSortOption {
        case .registeredDate:
            return result.sorted { ($0.registeredDate ?? Date()) > ($1.registeredDate ?? Date()) }
        case .patientId:
            return result.sorted { ($0.patientId ?? "") < ($1.patientId ?? "") }
        case .age:
            return result.sorted { $0.age > $1.age }
        }
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // ãƒ˜ãƒƒãƒ€ãƒ¼
                HStack {
                    Text("ç—‡ä¾‹ç®¡ç†")
                        .font(.title)
                        .fontWeight(.bold)
                    
                    Spacer()
                    
                    Button(action: { showAddPatient = true }) {
                        Label("æ–°è¦æ‚£è€…ç™»éŒ²", systemImage: "plus.circle.fill")
                    }
                    .buttonStyle(.borderedProminent)
                }
                .padding()
                
                Divider()
                
                // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ
                VStack(spacing: 10) {
                    HStack {
                        // æ¤œç´¢ãƒãƒ¼
                        HStack {
                            Image(systemName: "magnifyingglass")
                                .foregroundColor(.gray)
                            TextField("æ‚£è€…IDã§æ¤œç´¢", text: $searchText)
                            if !searchText.isEmpty {
                                Button(action: { searchText = "" }) {
                                    Image(systemName: "xmark.circle.fill")
                                        .foregroundColor(.gray)
                                }
                                .buttonStyle(.plain)
                            }
                        }
                        .padding(8)
                        .background(Color(NSColor.controlBackgroundColor))
                        .cornerRadius(8)
                        
                        // ã‚½ãƒ¼ãƒˆ
                        Picker("ä¸¦ã³æ›¿ãˆ", selection: $selectedSortOption) {
                            ForEach(SortOption.allCases) { option in
                                Text(option.rawValue).tag(option)
                            }
                        }
                        .pickerStyle(.menu)
                        .frame(width: 120)
                        
                        // é«˜åº¦ãªæ¤œç´¢
                        Button(action: { showAdvancedSearch.toggle() }) {
                            Label("ãƒ•ã‚£ãƒ«ã‚¿", systemImage: "line.3.horizontal.decrease.circle")
                        }
                    }
                    
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒƒã‚¸
                    if filterCategory != nil || filterType != nil {
                        HStack {
                            if let category = filterCategory {
                                FilterBadge(title: category) {
                                    filterCategory = nil
                                }
                            }
                            if let type = filterType {
                                FilterBadge(title: type) {
                                    filterType = nil
                                }
                            }
                            Spacer()
                        }
                    }
                }
                .padding(.horizontal)
                .padding(.vertical, 10)
                
                Divider()
                
                // æ‚£è€…ãƒªã‚¹ãƒˆ
                if filteredPatients.isEmpty {
                    VStack(spacing: 20) {
                        Image(systemName: "person.3")
                            .font(.system(size: 60))
                            .foregroundColor(.gray)
                        Text(searchText.isEmpty ? "æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“" : "æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“")
                            .font(.headline)
                            .foregroundColor(.secondary)
                    }
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
                } else {
                    List {
                        ForEach(filteredPatients, id: \.self) { patient in
                            NavigationLink(destination: PatientDetailView(patient: patient)) {
                                PatientRow(patient: patient)
                            }
                        }
                    }
                }
            }
            .sheet(isPresented: $showAddPatient) {
                AddPatientView()
            }
            .sheet(isPresented: $showAdvancedSearch) {
                AdvancedSearchView(
                    filterCategory: $filterCategory,
                    filterType: $filterType
                )
            }
            
            // åˆæœŸè¡¨ç¤º
            Text("æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„")
                .font(.title)
                .foregroundColor(.secondary)
        }
    }
}

// MARK: - FilterBadge

struct FilterBadge: View {
    let title: String
    let onRemove: () -> Void
    
    var body: some View {
        HStack(spacing: 5) {
            Text(title)
                .font(.caption)
            Button(action: onRemove) {
                Image(systemName: "xmark.circle.fill")
                    .font(.caption)
            }
            .buttonStyle(.plain)
        }
        .padding(.horizontal, 10)
        .padding(.vertical, 5)
        .background(Color.blue.opacity(0.2))
        .cornerRadius(15)
    }
}

// MARK: - PatientRow

struct PatientRow: View {
    let patient: Patient
    
    var surgeryCount: Int {
        patient.surgeries?.count ?? 0
    }
    
    var latestSurgery: Surgery? {
        let surgeries = (patient.surgeries?.allObjects as? [Surgery]) ?? []
        return surgeries.sorted { ($0.surgeryDate ?? Date()) > ($1.surgeryDate ?? Date()) }.first
    }
    
    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 5) {
                // æ‚£è€…IDã‚’è¡¨ç¤º
                HStack {
                    Text("æ‚£è€…ID:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    Text(patient.patientId ?? "ä¸æ˜")
                        .font(.headline)
                        .fontWeight(.bold)
                }
                
                HStack(spacing: 15) {
                    Label("\(patient.age)æ­³", systemImage: "person.fill")
                    Label(patient.gender ?? "ä¸æ˜", systemImage: "info.circle")
                    
                    if let surgery = latestSurgery {
                        Label(surgery.surgeryType ?? "ä¸æ˜", systemImage: "stethoscope")
                            .foregroundColor(.blue)
                    }
                }
                .font(.caption)
                .foregroundColor(.secondary)
            }
            
            Spacer()
            
            VStack(alignment: .trailing, spacing: 5) {
                Text("\(surgeryCount)ä»¶ã®æ‰‹è¡“")
                    .font(.caption)
                    .foregroundColor(.secondary)
                
                if let date = patient.registeredDate {
                    Text(date, style: .date)
                        .font(.caption2)
                        .foregroundColor(.secondary)
                }
            }
        }
        .padding(.vertical, 5)
    }
}

// MARK: - AdvancedSearchView

struct AdvancedSearchView: View {
    @Environment(\.dismiss) private var dismiss
    @Binding var filterCategory: String?
    @Binding var filterType: String?
    
    @State private var selectedCategory: SurgeryCategory?
    @State private var selectedType: SurgeryType?
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("é«˜åº¦ãªæ¤œç´¢")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("é–‰ã˜ã‚‹") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                Section("è¡“å¼ã‚«ãƒ†ã‚´ãƒª") {
                    Picker("ã‚«ãƒ†ã‚´ãƒª", selection: $selectedCategory) {
                        Text("ã™ã¹ã¦").tag(nil as SurgeryCategory?)
                        ForEach(SurgeryCategory.allCases, id: \.self) { category in
                            Text(category.displayName).tag(category as SurgeryCategory?)
                        }
                    }
                    .pickerStyle(.segmented)
                }
                
                if let category = selectedCategory {
                    Section("è¡“å¼") {
                        Picker("è¡“å¼", selection: $selectedType) {
                            Text("ã™ã¹ã¦").tag(nil as SurgeryType?)
                            ForEach(SurgeryType.types(for: category), id: \.self) { type in
                                Text(type.displayName).tag(type as SurgeryType?)
                            }
                        }
                    }
                }
            }
            .padding()
            
            Spacer()
            
            HStack {
                Button("ãƒªã‚»ãƒƒãƒˆ") {
                    selectedCategory = nil
                    selectedType = nil
                    filterCategory = nil
                    filterType = nil
                }
                .buttonStyle(.bordered)
                
                Spacer()
                
                Button("é©ç”¨") {
                    filterCategory = selectedCategory?.rawValue
                    filterType = selectedType?.rawValue
                    dismiss()
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
        }
        .frame(width: 500, height: 400)
    }
}

// MARK: - PatientDetailView

struct PatientDetailView: View {
    let patient: Patient
    @Environment(\.managedObjectContext) private var viewContext
    
    @State private var showAddSurgery = false
    @State private var showEditPatient = false
    
    var surgeries: [Surgery] {
        let surgerySet = patient.surgeries as? Set<Surgery> ?? []
        return surgerySet.sorted { ($0.surgeryDate ?? Date()) > ($1.surgeryDate ?? Date()) }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            HStack {
                VStack(alignment: .leading) {
                    HStack {
                        Text("æ‚£è€…ID:")
                            .font(.caption)
                            .foregroundColor(.secondary)
                        Text(patient.patientId ?? "ä¸æ˜")
                            .font(.title)
                            .fontWeight(.bold)
                    }
                    
                    HStack(spacing: 20) {
                        Label("\(patient.age)æ­³", systemImage: "person.fill")
                        Label(patient.gender ?? "ä¸æ˜", systemImage: "info.circle")
                    }
                    .font(.subheadline)
                    .foregroundColor(.secondary)
                }
                
                Spacer()
                
                Button(action: { showEditPatient = true }) {
                    Label("ç·¨é›†", systemImage: "pencil")
                }
                .buttonStyle(.bordered)
                
                Button(action: { showAddSurgery = true }) {
                    Label("æ‰‹è¡“ã‚’è¿½åŠ ", systemImage: "plus.circle.fill")
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
            
            Divider()
            
            // æ‰‹è¡“ãƒªã‚¹ãƒˆ
            if surgeries.isEmpty {
                VStack(spacing: 20) {
                    Image(systemName: "stethoscope")
                        .font(.system(size: 60))
                        .foregroundColor(.gray)
                    Text("æ‰‹è¡“è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“")
                        .font(.headline)
                        .foregroundColor(.secondary)
                    Button("æ‰‹è¡“ã‚’è¿½åŠ ") {
                        showAddSurgery = true
                    }
                    .buttonStyle(.borderedProminent)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    VStack(spacing: 15) {
                        ForEach(surgeries, id: \.self) { surgery in
                            Button(action: {
                            print("ğŸ” æ‰‹è¡“ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯")
                        }) {
                            SurgeryCard(surgery: surgery) // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
                        }
                        .buttonStyle(.plain)
                            .buttonStyle(.plain)
                        }
                    }
                    .padding()
                }
            }
        }
        .sheet(isPresented: $showAddSurgery) {
            AddSurgeryView(patient: patient)
        }
        .sheet(isPresented: $showEditPatient) {
            EditPatientView(patient: patient)
        }
    }
}

// MARK: - InfoRow

struct InfoRow: View {
    let label: String
    let value: String
    
    var body: some View {
        HStack {
            Text(label)
                .fontWeight(.semibold)
                .frame(width: 120, alignment: .leading)
            Text(value)
                .foregroundColor(.secondary)
            Spacer()
        }
    }
}


// MARK: - Surgery Card View
struct SurgeryCard: View {
    let surgery: Surgery
    @State private var showEditSheet = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text(surgery.surgeryType ?? "ä¸æ˜ãªè¡“å¼")
                    .font(.headline)
                Spacer()
                Button(action: { showEditSheet = true }) {
                    Image(systemName: "pencil")
                        .foregroundColor(.blue)
                }
            }
            
            Text("æ‰‹è¡“æ—¥: \(formattedDate(surgery.surgeryDate ?? Date()))")
                .font(.subheadline)
                .foregroundColor(.secondary)
            
            if let category = surgery.surgeryCategory {
                Text("ã‚«ãƒ†ã‚´ãƒª: \(category)")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            // VASER / Aquicell è¡¨ç¤º
            if surgery.surgeryType == "è„‚è‚ªè±Šèƒ¸" {
                HStack(spacing: 12) {
                    if surgery.vaserUsed {
                        Label("VASERä½¿ç”¨", systemImage: "checkmark.circle.fill")
                            .font(.caption)
                            .foregroundColor(.green)
                    }
                    if surgery.aquicellUsed {
                        Label("Aquicellä½¿ç”¨", systemImage: "checkmark.circle.fill")
                            .font(.caption)
                            .foregroundColor(.blue)
                    }
                }
            }
        }
        .padding()
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(8)
        .sheet(isPresented: $showEditSheet) {
            EditSurgeryView(surgery: surgery)
        }
    }
    
    private func formattedDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        formatter.locale = Locale(identifier: "ja_JP")
        return formatter.string(from: date)
    }
}

// MARK: - Follow-Up Card View
struct FollowUpCard: View {
    let followUp: FollowUp
    @State private var showEditSheet = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text(followUp.timing ?? "ä¸æ˜")
                    .font(.headline)
                Spacer()
                Button(action: { showEditSheet = true }) {
                    Image(systemName: "pencil")
                        .foregroundColor(.blue)
                }
            }
            
            Text("æ¸¬å®šæ—¥: \(formattedDate(followUp.measurementDate ?? Date()))")
                .font(.subheadline)
                .foregroundColor(.secondary)
            
            if followUp.breastQScore > 0 {
                Text("Breast-Q: \(followUp.breastQScore)")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
        }
        .padding()
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(8)
        .sheet(isPresented: $showEditSheet) {
            EditFollowUpView(followUp: followUp)
        }
    }
    
    private func formattedDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        formatter.locale = Locale(identifier: "ja_JP")
        return formatter.string(from: date)
    }
}

// MARK: - Add Patient View
struct AddPatientView: View {
    @Environment(\.presentationMode) var presentationMode
    
    @State private var patientId: String = ""
    @State private var age: String = ""
    @State private var gender: String = "å¥³æ€§"
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let genderOptions = ["å¥³æ€§", "ç”·æ€§", "ãã®ä»–"]
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("æ–°è¦æ‚£è€…ç™»éŒ²")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            Form {
                Section(header: Text("åŸºæœ¬æƒ…å ±")) {
                    TextField("é›»å­ã‚«ãƒ«ãƒ†ID", text: $patientId)
                    TextField("å¹´é½¢", text: $age)
                        .frame(width: 100)
                    Picker("æ€§åˆ¥", selection: $gender) {
                        ForEach(genderOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                }
            }
            .frame(maxWidth: .infinity, maxHeight: .infinity)
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ç™»éŒ²") {
                    savePatient()
                }
                .keyboardShortcut(.defaultAction)
                .disabled(patientId.isEmpty || age.isEmpty)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 500, height: 350)
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func savePatient() {
        guard let ageInt = Int(age) else {
            toastMessage = "å¹´é½¢ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
            showToast = true
            return
        }
        
        let context = Persistence.shared.container.viewContext
        _ = Persistence.shared.savePatient(
            context: context,
            patientId: patientId,
            age: ageInt,
            gender: gender
        )
        
        toastMessage = "æ‚£è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
        showToast = true
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
            presentationMode.wrappedValue.dismiss()
        }
    }
}

// MARK: - Edit Patient View
struct EditPatientView: View {
    @Environment(\.presentationMode) var presentationMode
    @ObservedObject var patient: Patient
    
    @State private var patientId: String = ""
    @State private var age: String = ""
    @State private var gender: String = "å¥³æ€§"
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let genderOptions = ["å¥³æ€§", "ç”·æ€§", "ãã®ä»–"]
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("æ‚£è€…æƒ…å ±ç·¨é›†")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            Form {
                Section(header: Text("åŸºæœ¬æƒ…å ±")) {
                    TextField("é›»å­ã‚«ãƒ«ãƒ†ID", text: $patientId)
                    TextField("å¹´é½¢", text: $age)
                        .frame(width: 100)
                    Picker("æ€§åˆ¥", selection: $gender) {
                        ForEach(genderOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                }
            }
            .frame(maxWidth: .infinity, maxHeight: .infinity)
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ä¿å­˜") {
                    savePatient()
                }
                .keyboardShortcut(.defaultAction)
                .disabled(patientId.isEmpty || age.isEmpty)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 500, height: 350)
        .onAppear {
            patientId = patient.patientId ?? ""
            age = String(patient.age)
            gender = patient.gender ?? "å¥³æ€§"
        }
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func savePatient() {
        guard let ageInt = Int(age) else {
            toastMessage = "å¹´é½¢ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
            showToast = true
            return
        }
        
        patient.patientId = patientId
        patient.age = Int16(ageInt)
        patient.gender = gender
        
        do {
            try Persistence.shared.container.viewContext.save()
            toastMessage = "æ‚£è€…æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
            showToast = true
            
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
                presentationMode.wrappedValue.dismiss()
            }
        } catch {
            toastMessage = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
            showToast = true
        }
    }
}


// MARK: - Add Surgery View
struct AddSurgeryView: View {
    @Environment(\.presentationMode) var presentationMode
    let patient: Patient
    
    @State private var surgeryDate = Date()
    @State private var surgeryCategory: SurgeryCategory = .breastAugmentation
    @State private var surgeryType: SurgeryType = .fatGraft
    @State private var vaserUsed = false
    @State private var aquicellUsed = false
    @State private var donorSite = "è…¹éƒ¨"
    @State private var donorSiteOther = ""
    @State private var rightBreastVolume = ""
    @State private var leftBreastVolume = ""
    @State private var preOpVectra = false
    @State private var skinLaxity = "æ­£å¸¸"
    @State private var notes = ""
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let donorSiteOptions = ["è…¹éƒ¨", "å¤§è…¿", "è‡€éƒ¨", "ãã®ä»–"]
    let skinLaxityOptions = ["æ­£å¸¸", "è»½åº¦", "ä¸­ç­‰åº¦", "é«˜åº¦"]
    
    var availableSurgeryTypes: [SurgeryType] {
        SurgeryType.allCases.filter { $0.category == surgeryCategory }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("æ–°è¦æ‰‹è¡“ç™»éŒ²")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            ScrollView {
                VStack(alignment: .leading, spacing: 16) {
                    // è¡“å¼é¸æŠ
                    GroupBox(label: Text("è¡“å¼é¸æŠ").font(.headline)) {
                        VStack(alignment: .leading, spacing: 12) {
                            Picker("è¡“å¼ã‚«ãƒ†ã‚´ãƒª", selection: $surgeryCategory) {
                                ForEach(SurgeryCategory.allCases, id: \.self) { category in
                                    Text(category.rawValue).tag(category)
                                }
                            }
                            .onChange(of: surgeryCategory) { newCategory in
                                if let firstType = SurgeryType.allCases.first(where: { $0.category == newCategory }) {
                                    surgeryType = firstType
                                }
                            }
                            
                            Picker("è¡“å¼", selection: $surgeryType) {
                                ForEach(availableSurgeryTypes, id: \.self) { type in
                                    Text(type.rawValue).tag(type)
                                }
                            }
                        }
                        .padding(8)
                    }
                    
                    // æ‰‹è¡“æ—¥
                    GroupBox(label: Text("æ‰‹è¡“æ—¥").font(.headline)) {
                        DatePicker("", selection: $surgeryDate, displayedComponents: .date)
                            .datePickerStyle(.field)
                            .padding(8)
                    }
                    
                    // è„‚è‚ªè±Šèƒ¸å›ºæœ‰ãƒ‡ãƒ¼ã‚¿
                    if surgeryType == .fatGraft {
                        GroupBox(label: Text("è„‚è‚ªè±Šèƒ¸ãƒ‡ãƒ¼ã‚¿").font(.headline)) {
                            VStack(alignment: .leading, spacing: 12) {
                                Toggle("VASERä½¿ç”¨", isOn: $vaserUsed)
                                Toggle("Aquicellä½¿ç”¨", isOn: $aquicellUsed)
                                
                                Picker("æ¡å–éƒ¨ä½", selection: $donorSite) {
                                    ForEach(donorSiteOptions, id: \.self) { site in
                                        Text(site).tag(site)
                                    }
                                }
                                
                                if donorSite == "ãã®ä»–" {
                                    TextField("æ¡å–éƒ¨ä½ï¼ˆãã®ä»–ï¼‰", text: $donorSiteOther)
                                }
                                
                                HStack {
                                    Text("æ³¨å…¥é‡")
                                    TextField("å³èƒ¸ (cc)", text: $rightBreastVolume)
                                        .frame(width: 100)
                                    TextField("å·¦èƒ¸ (cc)", text: $leftBreastVolume)
                                        .frame(width: 100)
                                }
                                
                                Toggle("è¡“å‰Vectraæ’®å½±", isOn: $preOpVectra)
                                
                                Picker("çš®è†šå¼›ç·©åº¦", selection: $skinLaxity) {
                                    ForEach(skinLaxityOptions, id: \.self) { laxity in
                                        Text(laxity).tag(laxity)
                                    }
                                }
                            }
                            .padding(8)
                        }
                    }
                    
                    // å‚™è€ƒ
                    GroupBox(label: Text("å‚™è€ƒ").font(.headline)) {
                        TextEditor(text: $notes)
                            .frame(height: 80)
                            .padding(8)
                    }
                }
                .padding()
            }
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ç™»éŒ²") {
                    saveSurgery()
                }
                .keyboardShortcut(.defaultAction)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 700, height: 600)
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func saveSurgery() {
        let context = Persistence.shared.container.viewContext
        _ = Persistence.shared.saveSurgery(
            context: context,
            patient: patient,
            surgeryDate: surgeryDate,
            surgeryCategory: surgeryCategory.rawValue,
            surgeryType: surgeryType.rawValue,
            vaserUsed: vaserUsed,
            aquicellUsed: aquicellUsed,
            preOpVectra: preOpVectra,
            skinLaxity: skinLaxity,
            donorSite: donorSite == "ãã®ä»–" ? donorSiteOther : donorSite,
            rightBreastVolume: rightBreastVolume,
            leftBreastVolume: leftBreastVolume,
            notes: notes
        )
        
        toastMessage = "æ‰‹è¡“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
        showToast = true
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
            presentationMode.wrappedValue.dismiss()
        }
    }
}

// MARK: - Edit Surgery View
struct EditSurgeryView: View {
    @Environment(\.presentationMode) var presentationMode
    @ObservedObject var surgery: Surgery
    
    @State private var surgeryDate = Date()
    @State private var surgeryCategory: SurgeryCategory = .breastAugmentation
    @State private var surgeryType: SurgeryType = .fatGraft
    @State private var vaserUsed = false
    @State private var aquicellUsed = false
    @State private var donorSite = "è…¹éƒ¨"
    @State private var donorSiteOther = ""
    @State private var rightBreastVolume = ""
    @State private var leftBreastVolume = ""
    @State private var preOpVectra = false
    @State private var skinLaxity = "æ­£å¸¸"
    @State private var notes = ""
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let donorSiteOptions = ["è…¹éƒ¨", "å¤§è…¿", "è‡€éƒ¨", "ãã®ä»–"]
    let skinLaxityOptions = ["æ­£å¸¸", "è»½åº¦", "ä¸­ç­‰åº¦", "é«˜åº¦"]
    
    var availableSurgeryTypes: [SurgeryType] {
        SurgeryType.allCases.filter { $0.category == surgeryCategory }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("æ‰‹è¡“æƒ…å ±ç·¨é›†")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            ScrollView {
                VStack(alignment: .leading, spacing: 16) {
                    // è¡“å¼é¸æŠ
                    GroupBox(label: Text("è¡“å¼é¸æŠ").font(.headline)) {
                        VStack(alignment: .leading, spacing: 12) {
                            Picker("è¡“å¼ã‚«ãƒ†ã‚´ãƒª", selection: $surgeryCategory) {
                                ForEach(SurgeryCategory.allCases, id: \.self) { category in
                                    Text(category.rawValue).tag(category)
                                }
                            }
                            .onChange(of: surgeryCategory) { newCategory in
                                if let firstType = SurgeryType.allCases.first(where: { $0.category == newCategory }) {
                                    surgeryType = firstType
                                }
                            }
                            
                            Picker("è¡“å¼", selection: $surgeryType) {
                                ForEach(availableSurgeryTypes, id: \.self) { type in
                                    Text(type.rawValue).tag(type)
                                }
                            }
                        }
                        .padding(8)
                    }
                    
                    // æ‰‹è¡“æ—¥
                    GroupBox(label: Text("æ‰‹è¡“æ—¥").font(.headline)) {
                        DatePicker("", selection: $surgeryDate, displayedComponents: .date)
                            .datePickerStyle(.field)
                            .padding(8)
                    }
                    
                    // è„‚è‚ªè±Šèƒ¸å›ºæœ‰ãƒ‡ãƒ¼ã‚¿
                    if surgeryType == .fatGraft {
                        GroupBox(label: Text("è„‚è‚ªè±Šèƒ¸ãƒ‡ãƒ¼ã‚¿").font(.headline)) {
                            VStack(alignment: .leading, spacing: 12) {
                                Toggle("VASERä½¿ç”¨", isOn: $vaserUsed)
                                Toggle("Aquicellä½¿ç”¨", isOn: $aquicellUsed)
                                
                                Picker("æ¡å–éƒ¨ä½", selection: $donorSite) {
                                    ForEach(donorSiteOptions, id: \.self) { site in
                                        Text(site).tag(site)
                                    }
                                }
                                
                                if donorSite == "ãã®ä»–" {
                                    TextField("æ¡å–éƒ¨ä½ï¼ˆãã®ä»–ï¼‰", text: $donorSiteOther)
                                }
                                
                                HStack {
                                    Text("æ³¨å…¥é‡")
                                    TextField("å³èƒ¸ (cc)", text: $rightBreastVolume)
                                        .frame(width: 100)
                                    TextField("å·¦èƒ¸ (cc)", text: $leftBreastVolume)
                                        .frame(width: 100)
                                }
                                
                                Toggle("è¡“å‰Vectraæ’®å½±", isOn: $preOpVectra)
                                
                                Picker("çš®è†šå¼›ç·©åº¦", selection: $skinLaxity) {
                                    ForEach(skinLaxityOptions, id: \.self) { laxity in
                                        Text(laxity).tag(laxity)
                                    }
                                }
                            }
                            .padding(8)
                        }
                    }
                    
                    // å‚™è€ƒ
                    GroupBox(label: Text("å‚™è€ƒ").font(.headline)) {
                        TextEditor(text: $notes)
                            .frame(height: 80)
                            .padding(8)
                    }
                }
                .padding()
            }
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ä¿å­˜") {
                    saveSurgery()
                }
                .keyboardShortcut(.defaultAction)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 700, height: 600)
        .onAppear {
            loadSurgeryData()
        }
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func loadSurgeryData() {
        surgeryDate = surgery.surgeryDate ?? Date()
        
        if let categoryStr = surgery.surgeryCategory,
           let category = SurgeryCategory(rawValue: categoryStr) {
            surgeryCategory = category
        }
        
        if let typeStr = surgery.surgeryType,
           let type = SurgeryType(rawValue: typeStr) {
            surgeryType = type
        }
        
        vaserUsed = surgery.vaserUsed
        aquicellUsed = surgery.aquicellUsed
        donorSite = surgery.donorSite ?? "è…¹éƒ¨"
        rightBreastVolume = surgery.rightBreastVolume ?? ""
        leftBreastVolume = surgery.leftBreastVolume ?? ""
        preOpVectra = surgery.preOpVectra
        skinLaxity = surgery.skinLaxity ?? "æ­£å¸¸"
        notes = surgery.notes ?? ""
    }
    
    private func saveSurgery() {
        surgery.surgeryDate = surgeryDate
        surgery.surgeryCategory = surgeryCategory.rawValue
        surgery.surgeryType = surgeryType.rawValue
        surgery.vaserUsed = vaserUsed
        surgery.aquicellUsed = aquicellUsed
        surgery.donorSite = donorSite == "ãã®ä»–" ? donorSiteOther : donorSite
        surgery.rightBreastVolume = rightBreastVolume
        surgery.leftBreastVolume = leftBreastVolume
        surgery.preOpVectra = preOpVectra
        surgery.skinLaxity = skinLaxity
        surgery.notes = notes
        
        do {
            try Persistence.shared.container.viewContext.save()
            toastMessage = "æ‰‹è¡“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
            showToast = true
            
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
                presentationMode.wrappedValue.dismiss()
            }
        } catch {
            toastMessage = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
            showToast = true
        }
    }
}

// MARK: - Add Follow-Up View
struct AddFollowUpView: View {
    @Environment(\.presentationMode) var presentationMode
    let surgery: Surgery
    
    @State private var timing = "1W"
    @State private var measurementDate = Date()
    @State private var breastQScore: Int16 = 0
    @State private var smokingStatus = "ãªã—"
    @State private var bodyWeight: Double = 0.0
    @State private var vectraPerformed = false
    @State private var notes = ""
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let timingOptions = ["1W", "1M", "3M", "6M", "1Y", "ãã®ä»–"]
    let smokingOptions = ["ãªã—", "ã‚ã‚Šï¼ˆç¶™ç¶šï¼‰", "ã‚ã‚Šï¼ˆç¦ç…™ä¸­ï¼‰"]
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("æ–°è¦ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨˜éŒ²")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            Form {
                Section(header: Text("åŸºæœ¬æƒ…å ±")) {
                    Picker("æ™‚æœŸ", selection: $timing) {
                        ForEach(timingOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                    DatePicker("æ¸¬å®šæ—¥", selection: $measurementDate, displayedComponents: .date)
                }
                
                Section(header: Text("æ¸¬å®šãƒ‡ãƒ¼ã‚¿")) {
                    TextField("ä½“é‡ (kg)", value: $bodyWeight, format: .number)
                    TextField("Breast-Q ã‚¹ã‚³ã‚¢", value: $breastQScore, format: .number)
                    Picker("å–«ç…™çŠ¶æ³", selection: $smokingStatus) {
                        ForEach(smokingOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                    Toggle("Vectraæ’®å½±å®Ÿæ–½", isOn: $vectraPerformed)
                }
                
                Section(header: Text("å‚™è€ƒ")) {
                    TextEditor(text: $notes)
                        .frame(height: 80)
                }
            }
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ç™»éŒ²") {
                    saveFollowUp()
                }
                .keyboardShortcut(.defaultAction)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 600, height: 500)
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func saveFollowUp() {
        let context = Persistence.shared.container.viewContext
        _ = Persistence.shared.saveFollowUp(
            context: context,
            surgery: surgery,
            timing: timing,
            measurementDate: measurementDate,
            vectraPerformed: vectraPerformed,
            bodyWeight: bodyWeight,
            smokingStatus: smokingStatus,
            breastQScore: Int(breastQScore),
            notes: notes
        )
        
        toastMessage = "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã‚’ç™»éŒ²ã—ã¾ã—ãŸ"
        showToast = true
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
            presentationMode.wrappedValue.dismiss()
        }
    }
}

// MARK: - Edit Follow-Up View
struct EditFollowUpView: View {
    @Environment(\.presentationMode) var presentationMode
    @ObservedObject var followUp: FollowUp
    
    @State private var timing = "1W"
    @State private var measurementDate = Date()
    @State private var breastQScore: Int16 = 0
    @State private var smokingStatus = "ãªã—"
    @State private var bodyWeight: Double = 0.0
    @State private var vectraPerformed = false
    @State private var notes = ""
    @State private var showToast = false
    @State private var toastMessage = ""
    
    let timingOptions = ["1W", "1M", "3M", "6M", "1Y", "ãã®ä»–"]
    let smokingOptions = ["ãªã—", "ã‚ã‚Šï¼ˆç¶™ç¶šï¼‰", "ã‚ã‚Šï¼ˆç¦ç…™ä¸­ï¼‰"]
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ç·¨é›†")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button(action: { presentationMode.wrappedValue.dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.secondary)
                        .imageScale(.large)
                }
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
            
            // Form Content
            Form {
                Section(header: Text("åŸºæœ¬æƒ…å ±")) {
                    Picker("æ™‚æœŸ", selection: $timing) {
                        ForEach(timingOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                    DatePicker("æ¸¬å®šæ—¥", selection: $measurementDate, displayedComponents: .date)
                }
                
                Section(header: Text("æ¸¬å®šãƒ‡ãƒ¼ã‚¿")) {
                    TextField("ä½“é‡ (kg)", value: $bodyWeight, format: .number)
                    TextField("Breast-Q ã‚¹ã‚³ã‚¢", value: $breastQScore, format: .number)
                    Picker("å–«ç…™çŠ¶æ³", selection: $smokingStatus) {
                        ForEach(smokingOptions, id: \.self) { option in
                            Text(option).tag(option)
                        }
                    }
                    Toggle("Vectraæ’®å½±å®Ÿæ–½", isOn: $vectraPerformed)
                }
                
                Section(header: Text("å‚™è€ƒ")) {
                    TextEditor(text: $notes)
                        .frame(height: 80)
                }
            }
            
            // Footer
            HStack {
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    presentationMode.wrappedValue.dismiss()
                }
                .keyboardShortcut(.cancelAction)
                
                Button("ä¿å­˜") {
                    saveFollowUp()
                }
                .keyboardShortcut(.defaultAction)
            }
            .padding()
            .background(Color(NSColor.controlBackgroundColor))
        }
        .frame(width: 600, height: 500)
        .onAppear {
            timing = followUp.timing ?? "1W"
            measurementDate = followUp.measurementDate ?? Date()
            breastQScore = followUp.breastQScore
            smokingStatus = followUp.smokingStatus ?? "ãªã—"
            bodyWeight = followUp.bodyWeight
            vectraPerformed = followUp.vectraPerformed
            notes = followUp.notes ?? ""
        }
        .overlay(
            ToastView(message: toastMessage, isShowing: $showToast)
                .animation(.easeInOut, value: showToast)
            , alignment: .top
        )
    }
    
    private func saveFollowUp() {
        followUp.timing = timing
        followUp.measurementDate = measurementDate
        followUp.breastQScore = breastQScore
        followUp.smokingStatus = smokingStatus
        followUp.bodyWeight = bodyWeight
        followUp.vectraPerformed = vectraPerformed
        followUp.notes = notes
        
        do {
            try Persistence.shared.container.viewContext.save()
            toastMessage = "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
            showToast = true
            
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
                presentationMode.wrappedValue.dismiss()
            }
        } catch {
            toastMessage = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
            showToast = true
        }
    }
}

// MARK: - Toast View
struct ToastView: View {
    let message: String
    @Binding var isShowing: Bool
    
    var body: some View {
        if isShowing {
            Text(message)
                .padding()
                .background(Color.black.opacity(0.8))
                .foregroundColor(.white)
                .cornerRadius(8)
                .padding(.top, 50)
                .onAppear {
                    DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                        isShowing = false
                    }
                }
        }
    }
}

