import SwiftUI
import CoreData
import AppKit
import UniformTypeIdentifiers

struct PhotoUploadView: View {
    let surgery: Surgery
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var selectedImages: [UploadImage] = []
    @State private var isProcessing = false
    @State private var showToast = false
    @State private var toastMessage = ""
    @State private var uploadProgress: Double = 0
    @State private var uploadCount: Int = 0
    
    // ãƒ‰ãƒ©ãƒƒã‚°é¸æŠç”¨
    @State private var selectionStart: Int? = nil
    @State private var currentAngle = "æ­£é¢"
    
    private let maxUploadCount = 100  // ä¸Šé™ã‚’100æšã«
    
    var body: some View {
        VStack(spacing: 0) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            HStack {
                Text("ğŸ“¸ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("ã‚­ãƒ£ãƒ³ã‚»ãƒ«") {
                    dismiss()
                }
            }
            .padding()
            
            Divider()
            
            if selectedImages.isEmpty {
                // å†™çœŸé¸æŠã‚¨ãƒªã‚¢
                VStack(spacing: 20) {
                    Image(systemName: "photo.on.rectangle.angled")
                        .font(.system(size: 80))
                        .foregroundColor(.gray)
                    
                    Text("å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„")
                        .font(.headline)
                    
                    Text("ä¸€åº¦ã«æœ€å¤§\(maxUploadCount)æšã¾ã§é¸æŠã§ãã¾ã™")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Button("å†™çœŸã‚’é¸æŠ") {
                        selectPhotos()
                    }
                    .buttonStyle(.borderedProminent)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + è§’åº¦è¨­å®šã‚¨ãƒªã‚¢
                VStack(spacing: 15) {
                    // é€²è¡ŒçŠ¶æ³ãƒãƒ¼ï¼ˆä¿å­˜ä¸­ã®ã¿è¡¨ç¤ºï¼‰
                    if isProcessing {
                        VStack(spacing: 10) {
                            ProgressView(value: uploadProgress, total: Double(selectedImages.count))
                                .progressViewStyle(.linear)
                            
                            Text("ä¿å­˜ä¸­... \(uploadCount) / \(selectedImages.count)æš")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        .padding()
                    }
                    
                    // è§’åº¦é¸æŠ + æƒ…å ±
                    HStack {
                        Text("è§’åº¦è¨­å®š:")
                            .fontWeight(.semibold)
                        
                        Picker("è§’åº¦", selection: $currentAngle) {
                            Text("æ­£é¢").tag("æ­£é¢")
                            Text("å³å´é¢").tag("å³å´é¢")
                            Text("å·¦å´é¢").tag("å·¦å´é¢")
                            Text("å³æ–œã‚").tag("å³æ–œã‚")
                            Text("å·¦æ–œã‚").tag("å·¦æ–œã‚")
                            Text("ãã®ä»–").tag("ãã®ä»–")
                        }
                        .pickerStyle(.segmented)
                        .frame(maxWidth: 500)
                        
                        Spacer()
                        
                        Text("\(selectedImages.count)æšé¸æŠä¸­")
                            .foregroundColor(selectedImages.count > maxUploadCount ? .red : .secondary)
                            .fontWeight(selectedImages.count > maxUploadCount ? .bold : .regular)
                        
                        Button("ä¸€æ‹¬è¨­å®š") {
                            applyAngleToAll()
                        }
                        .buttonStyle(.bordered)
                    }
                    .padding(.horizontal)
                    
                    // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ100æšè¶…éæ™‚ï¼‰
                    if selectedImages.count > maxUploadCount {
                        HStack {
                            Image(systemName: "exclamationmark.triangle.fill")
                                .foregroundColor(.orange)
                            Text("é¸æŠæšæ•°ãŒä¸Šé™(\(maxUploadCount)æš)ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚\(selectedImages.count - maxUploadCount)æšå‰Šæ¸›ã—ã¦ãã ã•ã„ã€‚")
                                .font(.caption)
                                .foregroundColor(.orange)
                        }
                        .padding(.horizontal)
                    }
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°é¸æŠã®èª¬æ˜
                    HStack {
                        Image(systemName: "info.circle")
                            .foregroundColor(.blue)
                        Text("Shiftã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§ç¯„å›²é¸æŠ â†’ è§’åº¦ã‚’ä¸€æ‹¬è¨­å®šã§ãã¾ã™")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    .padding(.horizontal)
                    
                    // ã‚µãƒ ãƒã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰
                    ScrollView {
                        LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 10), count: 5), spacing: 10) {
                            ForEach(Array(selectedImages.enumerated()), id: \.offset) { index, image in
                                PhotoThumbnailCell(
                                    image: image,
                                    index: index,
                                    isSelected: image.isSelected,
                                    onTap: {
                                        handleTap(index: index)
                                    },
                                    onDelete: {
                                        deleteImage(at: index)
                                    }
                                )
                            }
                        }
                        .padding()
                    }
                    
                    Divider()
                    
                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                    HStack {
                        Button("å†™çœŸã‚’è¿½åŠ é¸æŠ") {
                            selectPhotos()
                        }
                        .buttonStyle(.bordered)
                        .disabled(isProcessing)
                        
                        Spacer()
                        
                        Button("é¸æŠä¸­ã®å†™çœŸã«è§’åº¦ã‚’è¨­å®š") {
                            applyAngleToSelected()
                        }
                        .disabled(selectedImages.filter(\.isSelected).isEmpty || isProcessing)
                        .buttonStyle(.borderedProminent)
                        
                        Button("ä¿å­˜") {
                            savePhotos()
                        }
                        .disabled(isProcessing || selectedImages.count > maxUploadCount)
                        .buttonStyle(.borderedProminent)
                    }
                    .padding()
                }
            }
        }
        .frame(width: 900, height: 700)
        .overlay(
            Group {
                if showToast {
                    VStack {
                        Text(toastMessage)
                            .padding()
                            .background(Color.black.opacity(0.8))
                            .foregroundColor(.white)
                            .cornerRadius(8)
                            .padding(.top, 50)
                        Spacer()
                    }
                    .transition(.move(edge: .top).combined(with: .opacity))
                }
            }
        )
    }
    
    // MARK: - Functions
    
    private func selectPhotos() {
        let panel = NSOpenPanel()
        panel.allowsMultipleSelection = true
        panel.canChooseDirectories = false
        panel.canChooseFiles = true
        panel.allowedContentTypes = [.image]
        
        if panel.runModal() == .OK {
            let urls = panel.urls
            
            // ä¸Šé™ãƒã‚§ãƒƒã‚¯
            let remainingSlots = maxUploadCount - selectedImages.count
            let urlsToProcess = Array(urls.prefix(remainingSlots))
            
            if urls.count > remainingSlots {
                showToastMessage("âš ï¸ ä¸Šé™(\(maxUploadCount)æš)ã®ãŸã‚ã€\(remainingSlots)æšã®ã¿èª­ã¿è¾¼ã¿ã¾ã—ãŸ")
            }
            
            for url in urlsToProcess {
                if let imageData = try? Data(contentsOf: url),
                   let nsImage = NSImage(data: imageData) {
                    
                    var timing = "è¡“å‰"
                    var daysAfter: Int = 0
                    var exifDate: Date? = nil
                    
                    // EXIFæ—¥ä»˜ã‚’æŠ½å‡º
                    if let extractedDate = PhotoManager.shared.extractEXIFDate(from: imageData) {
                        exifDate = extractedDate
                        
                        // æ‰‹è¡“æ—¥ã¨ã®çµŒéæ—¥æ•°ã‚’è¨ˆç®—
                        if let surgeryDate = surgery.surgeryDate {
                            daysAfter = PhotoManager.shared.calculateDaysAfterSurgery(
                                surgeryDate: surgeryDate,
                                photoDate: extractedDate
                            )
                            
                            // æ™‚æœŸã‚’æ¨å®š
                            timing = PhotoManager.shared.estimateTiming(from: daysAfter)
                            
                            print("ğŸ“… å†™çœŸèª­è¾¼: EXIF=\(extractedDate), æ‰‹è¡“æ—¥=\(surgeryDate), çµŒé=\(daysAfter)æ—¥, æ™‚æœŸ=\(timing)")
                        }
                    } else {
                        print("âš ï¸ EXIFæ—¥ä»˜ãªã— â†’ è¡“å‰ã¨ã—ã¦æ‰±ã„ã¾ã™")
                    }
                    
                    let uploadImage = UploadImage(
                        nsImage: nsImage,
                        imageData: imageData,
                        angle: currentAngle,
                        timing: timing,
                        exifDate: exifDate,
                        daysAfterSurgery: daysAfter
                    )
                    
                    selectedImages.append(uploadImage)
                }
            }
            
            if urls.count <= remainingSlots {
                showToastMessage("ğŸ“¸ \(urlsToProcess.count)æšã®å†™çœŸã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ")
            }
        }
    }
    
    private func handleTap(index: Int) {
        let isShiftPressed = NSEvent.modifierFlags.contains(.shift)
        
        if isShiftPressed {
            // Shift+ã‚¯ãƒªãƒƒã‚¯: ç¯„å›²é¸æŠ
            if let start = selectionStart {
                let range = min(start, index)...max(start, index)
                for i in range {
                    selectedImages[i].isSelected = true
                }
                selectionStart = nil
            } else {
                selectionStart = index
                selectedImages[index].isSelected.toggle()
            }
        } else {
            // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯: å˜ä¸€é¸æŠãƒˆã‚°ãƒ«
            selectedImages[index].isSelected.toggle()
            selectionStart = index
        }
    }
    
    private func deleteImage(at index: Int) {
        selectedImages.remove(at: index)
        showToastMessage("ğŸ—‘ï¸ 1æšå‰Šé™¤ã—ã¾ã—ãŸ")
    }
    
    private func applyAngleToSelected() {
        for i in selectedImages.indices {
            if selectedImages[i].isSelected {
                selectedImages[i].angle = currentAngle
                selectedImages[i].isSelected = false
            }
        }
        selectionStart = nil
        showToastMessage("âœ… é¸æŠã—ãŸå†™çœŸã«ã€Œ\(currentAngle)ã€ã‚’è¨­å®šã—ã¾ã—ãŸ")
    }
    
    private func applyAngleToAll() {
        for i in selectedImages.indices {
            selectedImages[i].angle = currentAngle
        }
        showToastMessage("âœ… å…¨ã¦ã®å†™çœŸã«ã€Œ\(currentAngle)ã€ã‚’è¨­å®šã—ã¾ã—ãŸ")
    }
    
    private func savePhotos() {
        isProcessing = true
        uploadProgress = 0
        uploadCount = 0
        
        // éåŒæœŸã§ä¿å­˜ï¼ˆUIãŒãƒ•ãƒªãƒ¼ã‚ºã—ãªã„ã‚ˆã†ã«ï¼‰
        DispatchQueue.global(qos: .userInitiated).async {
            for (index, image) in selectedImages.enumerated() {
                // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§Core Dataæ“ä½œ
                DispatchQueue.main.async {
                    PhotoManager.shared.savePhoto(
                        context: viewContext,
                        surgery: surgery,
                        imageData: image.imageData,
                        angle: image.angle,
                        notes: nil,
                        surgeryDate: surgery.surgeryDate ?? Date()
                    )
                    
                    uploadCount = index + 1
                    uploadProgress = Double(index + 1)
                }
                
                // å°‘ã—å¾…æ©Ÿï¼ˆUIæ›´æ–°ã®ãŸã‚ï¼‰
                Thread.sleep(forTimeInterval: 0.01)
            }
            
            // å®Œäº†
            DispatchQueue.main.async {
                isProcessing = false
                showToastMessage("âœ… \(selectedImages.count)æšã®å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸ")
                
                DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
                    dismiss()
                }
            }
        }
    }
    
    private func showToastMessage(_ message: String) {
        toastMessage = message
        withAnimation {
            showToast = true
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            withAnimation {
                showToast = false
            }
        }
    }
}

// MARK: - UploadImage Model

struct UploadImage: Identifiable {
    let id = UUID()
    let nsImage: NSImage
    let imageData: Data
    var angle: String
    var timing: String
    var exifDate: Date?
    var daysAfterSurgery: Int
    var notes: String?
    var isSelected: Bool = false
}

// MARK: - PhotoThumbnailCell

struct PhotoThumbnailCell: View {
    let image: UploadImage
    let index: Int
    let isSelected: Bool
    let onTap: () -> Void
    let onDelete: () -> Void
    
    var body: some View {
        VStack(spacing: 5) {
            ZStack(alignment: .topLeading) {
                if let cgImage = image.nsImage.cgImage(forProposedRect: nil, context: nil, hints: nil) {
                    Image(decorative: cgImage, scale: 1.0)
                        .resizable()
                        .scaledToFill()
                        .frame(width: 150, height: 150)
                        .clipShape(RoundedRectangle(cornerRadius: 8))
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(isSelected ? Color.blue : Color.gray.opacity(0.3), lineWidth: isSelected ? 3 : 1)
                        )
                }
                
                // é¸æŠãƒãƒ¼ã‚¯
                if isSelected {
                    Image(systemName: "checkmark.circle.fill")
                        .foregroundColor(.blue)
                        .background(Color.white.clipShape(Circle()))
                        .padding(5)
                }
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³
                VStack {
                    Spacer()
                    HStack {
                        Spacer()
                        Button(action: onDelete) {
                            Image(systemName: "trash.circle.fill")
                                .foregroundColor(.red)
                                .background(Color.white.clipShape(Circle()))
                        }
                        .buttonStyle(.plain)
                        .padding(5)
                    }
                }
            }
            .onTapGesture {
                onTap()
            }
            
            // è§’åº¦
            Text(image.angle)
                .font(.caption)
                .fontWeight(.semibold)
                .foregroundColor(.blue)
            
            // æ™‚æœŸ (Day XX ã‚’è¡¨ç¤º)
            Text(image.timing)
                .font(.caption2)
                .foregroundColor(image.timing == "è¡“å‰" ? .secondary : .green)
                .fontWeight(image.timing.starts(with: "Day") ? .semibold : .regular)
        }
    }
}
