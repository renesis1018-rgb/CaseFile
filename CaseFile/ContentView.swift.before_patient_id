import SwiftUI
import CoreData

struct ContentView: View {
    @Environment(\.managedObjectContext) private var viewContext
    
    @FetchRequest(
        sortDescriptors: [NSSortDescriptor(keyPath: \Patient.registeredDate, ascending: false)],
        animation: .default)
    private var patients: FetchedResults<Patient>
    
    @State private var searchText = ""
    @State private var showAddPatient = false
    @State private var selectedSortOption: SortOption = .registeredDate
    @State private var showAdvancedSearch = false
    @State private var filterCategory: String? = nil
    @State private var filterType: String? = nil
    
    enum SortOption: String, CaseIterable, Identifiable {
        case registeredDate = "ÁôªÈå≤Êó•"
        case name = "Ê∞èÂêç"
        case age = "Âπ¥ÈΩ¢"
        
        var id: String { rawValue }
    }
    
    var filteredPatients: [Patient] {
        var result = patients.filter { patient in
            if searchText.isEmpty {
                return true
            }
            return patient.patientId?.localizedCaseInsensitiveContains(searchText) ?? false
        }
        
        // Ë°ìÂºè„Ç´„ÉÜ„Ç¥„É™„Åß„Éï„Ç£„É´„Çø
        if let category = filterCategory {
            result = result.filter { patient in
                patient.surgeries?.contains(where: { surgery in
                    (surgery as? Surgery)?.surgeryCategory == category
                }) ?? false
            }
        }
        
        // Ë°ìÂºè„Çø„Ç§„Éó„Åß„Éï„Ç£„É´„Çø
        if let type = filterType {
            result = result.filter { patient in
                patient.surgeries?.contains(where: { surgery in
                    (surgery as? Surgery)?.surgeryType == type
                }) ?? false
            }
        }
        
        // „ÇΩ„Éº„Éà
        switch selectedSortOption {
        case .registeredDate:
            return result.sorted { ($0.registeredDate ?? Date()) > ($1.registeredDate ?? Date()) }
        case .name:
            return result.sorted { ($0.name ?? "") < ($1.name ?? "") }
        case .age:
            return result.sorted { $0.age > $1.age }
        }
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // „Éò„ÉÉ„ÉÄ„Éº
                HStack {
                    Text("Áóá‰æãÁÆ°ÁêÜ")
                        .font(.title)
                        .fontWeight(.bold)
                    
                    Spacer()
                    
                    Button(action: { showAddPatient = true }) {
                        Label("Êñ∞Ë¶èÊÇ£ËÄÖÁôªÈå≤", systemImage: "plus.circle.fill")
                    }
                    .buttonStyle(.borderedProminent)
                }
                .padding()
                
                Divider()
                
                // Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éª„ÇΩ„Éº„Éà
                VStack(spacing: 10) {
                    HStack {
                        // Ê§úÁ¥¢„Éê„Éº
                        HStack {
                            Image(systemName: "magnifyingglass")
                                .foregroundColor(.gray)
                            TextField("ÊÇ£ËÄÖÂêç„ÅßÊ§úÁ¥¢", text: $searchText)
                            if !searchText.isEmpty {
                                Button(action: { searchText = "" }) {
                                    Image(systemName: "xmark.circle.fill")
                                        .foregroundColor(.gray)
                                }
                                .buttonStyle(.plain)
                            }
                        }
                        .padding(8)
                        .background(Color(NSColor.controlBackgroundColor))
                        .cornerRadius(8)
                        
                        // „ÇΩ„Éº„Éà
                        Picker("‰∏¶„Å≥Êõø„Åà", selection: $selectedSortOption) {
                            ForEach(SortOption.allCases) { option in
                                Text(option.rawValue).tag(option)
                            }
                        }
                        .pickerStyle(.menu)
                        .frame(width: 120)
                        
                        // È´òÂ∫¶„Å™Ê§úÁ¥¢
                        Button(action: { showAdvancedSearch.toggle() }) {
                            Label("„Éï„Ç£„É´„Çø", systemImage: "line.3.horizontal.decrease.circle")
                        }
                    }
                    
                    // „Éï„Ç£„É´„Çø„Éê„ÉÉ„Ç∏
                    if filterCategory != nil || filterType != nil {
                        HStack {
                            if let category = filterCategory {
                                FilterBadge(title: category) {
                                    filterCategory = nil
                                }
                            }
                            if let type = filterType {
                                FilterBadge(title: type) {
                                    filterType = nil
                                }
                            }
                            Spacer()
                        }
                    }
                }
                .padding(.horizontal)
                .padding(.vertical, 10)
                
                Divider()
                
                // ÊÇ£ËÄÖ„É™„Çπ„Éà
                if filteredPatients.isEmpty {
                    VStack(spacing: 20) {
                        Image(systemName: "person.3")
                            .font(.system(size: 60))
                            .foregroundColor(.gray)
                        Text(searchText.isEmpty ? "ÊÇ£ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì" : "Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")
                            .font(.headline)
                            .foregroundColor(.secondary)
                    }
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
                } else {
                    List {
                        ForEach(filteredPatients, id: \.self) { patient in
                            NavigationLink(destination: PatientDetailView(patient: patient)) {
                                PatientRow(patient: patient)
                            }
                        }
                    }
                }
            }
            .sheet(isPresented: $showAddPatient) {
                AddPatientView()
            }
            .sheet(isPresented: $showAdvancedSearch) {
                AdvancedSearchView(
                    filterCategory: $filterCategory,
                    filterType: $filterType
                )
            }
            
            // ÂàùÊúüË°®Á§∫
            Text("ÊÇ£ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
                .font(.title)
                .foregroundColor(.secondary)
        }
    }
}

// MARK: - FilterBadge

struct FilterBadge: View {
    let title: String
    let onRemove: () -> Void
    
    var body: some View {
        HStack(spacing: 5) {
            Text(title)
                .font(.caption)
            Button(action: onRemove) {
                Image(systemName: "xmark.circle.fill")
                    .font(.caption)
            }
            .buttonStyle(.plain)
        }
        .padding(.horizontal, 10)
        .padding(.vertical, 5)
        .background(Color.blue.opacity(0.2))
        .cornerRadius(15)
    }
}

// MARK: - PatientRow

struct PatientRow: View {
    let patient: Patient
    
    var surgeryCount: Int {
        patient.surgeries?.count ?? 0
    }
    
    var latestSurgery: Surgery? {
        let surgeries = (patient.surgeries?.allObjects as? [Surgery]) ?? []
        return surgeries.sorted { ($0.surgeryDate ?? Date()) > ($1.surgeryDate ?? Date()) }.first
    }
    
    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 5) {
                Text(patient.name ?? "‰∏çÊòé")
                    .font(.headline)
                
                HStack(spacing: 15) {
                    Label("\(patient.age)Ê≠≥", systemImage: "person.fill")
                    Label(patient.gender ?? "‰∏çÊòé", systemImage: "info.circle")
                    
                    if let surgery = latestSurgery {
                        Label(surgery.surgeryType ?? "‰∏çÊòé", systemImage: "stethoscope")
                            .foregroundColor(.blue)
                    }
                }
                .font(.caption)
                .foregroundColor(.secondary)
            }
            
            Spacer()
            
            VStack(alignment: .trailing, spacing: 5) {
                Text("\(surgeryCount)‰ª∂„ÅÆÊâãË°ì")
                    .font(.caption)
                    .foregroundColor(.secondary)
                
                if let date = patient.registeredDate {
                    Text(date, style: .date)
                        .font(.caption2)
                        .foregroundColor(.secondary)
                }
            }
        }
        .padding(.vertical, 5)
    }
}

// MARK: - AdvancedSearchView

struct AdvancedSearchView: View {
    @Environment(\.dismiss) private var dismiss
    @Binding var filterCategory: String?
    @Binding var filterType: String?
    
    @State private var selectedCategory: SurgeryCategory?
    @State private var selectedType: SurgeryType?
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("È´òÂ∫¶„Å™Ê§úÁ¥¢")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("Èñâ„Åò„Çã") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                Section("Ë°ìÂºè„Ç´„ÉÜ„Ç¥„É™") {
                    Picker("„Ç´„ÉÜ„Ç¥„É™", selection: $selectedCategory) {
                        Text("„Åô„Åπ„Å¶").tag(nil as SurgeryCategory?)
                        ForEach(SurgeryCategory.allCases, id: \.self) { category in
                            Text(category.displayName).tag(category as SurgeryCategory?)
                        }
                    }
                    .pickerStyle(.segmented)
                }
                
                if let category = selectedCategory {
                    Section("Ë°ìÂºè") {
                        Picker("Ë°ìÂºè", selection: $selectedType) {
                            Text("„Åô„Åπ„Å¶").tag(nil as SurgeryType?)
                            ForEach(SurgeryType.types(for: category), id: \.self) { type in
                                Text(type.displayName).tag(type as SurgeryType?)
                            }
                        }
                    }
                }
            }
            .padding()
            
            Spacer()
            
            HStack {
                Button("„É™„Çª„ÉÉ„Éà") {
                    selectedCategory = nil
                    selectedType = nil
                    filterCategory = nil
                    filterType = nil
                }
                .buttonStyle(.bordered)
                
                Spacer()
                
                Button("ÈÅ©Áî®") {
                    filterCategory = selectedCategory?.rawValue
                    filterType = selectedType?.rawValue
                    dismiss()
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
        }
        .frame(width: 500, height: 400)
    }
}

// MARK: - PatientDetailView

struct PatientDetailView: View {
    let patient: Patient
    @Environment(\.managedObjectContext) private var viewContext
    
    @State private var showAddSurgery = false
    @State private var showEditPatient = false
    
    var surgeries: [Surgery] {
        let surgerySet = patient.surgeries as? Set<Surgery> ?? []
        return surgerySet.sorted { ($0.surgeryDate ?? Date()) > ($1.surgeryDate ?? Date()) }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // „Éò„ÉÉ„ÉÄ„Éº
            HStack {
                VStack(alignment: .leading) {
                    Text(patient.name ?? "‰∏çÊòé")
                        .font(.title)
                        .fontWeight(.bold)
                    
                    HStack(spacing: 20) {
                        Label("\(patient.age)Ê≠≥", systemImage: "person.fill")
                        Label(patient.gender ?? "‰∏çÊòé", systemImage: "info.circle")
                        if let contact = patient.contactInfo {
                            Label(contact, systemImage: "phone.fill")
                        }
                    }
                    .font(.subheadline)
                    .foregroundColor(.secondary)
                }
                
                Spacer()
                
                Button(action: { showEditPatient = true }) {
                    Label("Á∑®ÈõÜ", systemImage: "pencil")
                }
                .buttonStyle(.bordered)
                
                Button(action: { showAddSurgery = true }) {
                    Label("ÊâãË°ì„ÇíËøΩÂä†", systemImage: "plus.circle.fill")
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
            
            Divider()
            
            // ÊâãË°ì„É™„Çπ„Éà
            if surgeries.isEmpty {
                VStack(spacing: 20) {
                    Image(systemName: "stethoscope")
                        .font(.system(size: 60))
                        .foregroundColor(.gray)
                    Text("ÊâãË°ìË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")
                        .font(.headline)
                        .foregroundColor(.secondary)
                    Button("ÊâãË°ì„ÇíËøΩÂä†") {
                        showAddSurgery = true
                    }
                    .buttonStyle(.borderedProminent)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    VStack(spacing: 15) {
                        ForEach(surgeries, id: \.self) { surgery in
                            NavigationLink(destination: SurgeryDetailView(surgery: surgery)) {
                                SurgeryCardView(surgery: surgery)
                            }
                            .buttonStyle(.plain)
                        }
                    }
                    .padding()
                }
            }
        }
        .sheet(isPresented: $showAddSurgery) {
            AddSurgeryView(patient: patient)
        }
        .sheet(isPresented: $showEditPatient) {
            EditPatientView(patient: patient)
        }
    }
}

// MARK: - InfoRow

struct InfoRow: View {
    let label: String
    let value: String
    
    var body: some View {
        HStack {
            Text(label)
                .fontWeight(.semibold)
                .frame(width: 120, alignment: .leading)
            Text(value)
                .foregroundColor(.secondary)
            Spacer()
        }
    }
}

// MARK: - SurgeryCardView

struct SurgeryCardView: View {
    let surgery: Surgery
    
    var followUpCount: Int {
        surgery.followUps?.count ?? 0
    }
    
    var photoCount: Int {
        surgery.photos?.count ?? 0
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 10) {
            HStack {
                VStack(alignment: .leading, spacing: 5) {
                    // Ë°ìÂºè„Ç´„ÉÜ„Ç¥„É™„Å®Ë°ìÂºè
                    HStack {
                        Text(surgery.surgeryCategory ?? "‰∏çÊòé")
                            .font(.caption)
                            .padding(.horizontal, 8)
                            .padding(.vertical, 4)
                            .background(Color.blue.opacity(0.2))
                            .cornerRadius(8)
                        
                        Text(surgery.surgeryType ?? "‰∏çÊòé")
                            .font(.headline)
                            .fontWeight(.bold)
                    }
                    
                    if let date = surgery.surgeryDate {
                        Text(date, style: .date)
                            .font(.subheadline)
                            .foregroundColor(.secondary)
                    }
                }
                
                Spacer()
                
                Image(systemName: "chevron.right")
                    .foregroundColor(.secondary)
            }
            
            Divider()
            
            HStack(spacing: 20) {
                Label("\(followUpCount)Âõû", systemImage: "calendar.badge.clock")
                Label("\(photoCount)Êûö", systemImage: "photo.on.rectangle")
            }
            .font(.caption)
            .foregroundColor(.secondary)
        }
        .padding()
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(12)
        .shadow(radius: 2)
    }
}

// MARK: - SurgeryDetailView

struct SurgeryDetailView: View {
    let surgery: Surgery
    @Environment(\.managedObjectContext) private var viewContext
    
    @State private var selectedTab = 0
    @State private var showEditSurgery = false
    @State private var showAddFollowUp = false
    
    var followUps: [FollowUp] {
        let followUpSet = surgery.followUps as? Set<FollowUp> ?? []
        return followUpSet.sorted { ($0.measurementDate ?? Date()) < ($1.measurementDate ?? Date()) }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // „Éò„ÉÉ„ÉÄ„Éº
            HStack {
                VStack(alignment: .leading) {
                    HStack {
                        Text(surgery.surgeryCategory ?? "‰∏çÊòé")
                            .font(.caption)
                            .padding(.horizontal, 8)
                            .padding(.vertical, 4)
                            .background(Color.blue.opacity(0.2))
                            .cornerRadius(8)
                        
                        Text(surgery.surgeryType ?? "‰∏çÊòé")
                            .font(.title2)
                            .fontWeight(.bold)
                    }
                    
                    if let date = surgery.surgeryDate {
                        Text(date, style: .date)
                            .foregroundColor(.secondary)
                    }
                }
                
                Spacer()
                
                Button(action: { showEditSurgery = true }) {
                    Label("Á∑®ÈõÜ", systemImage: "pencil")
                }
                .buttonStyle(.bordered)
            }
            .padding()
            
            Divider()
            
            // „Çø„Éñ
            Picker("", selection: $selectedTab) {
                Text("ÊâãË°ìÊÉÖÂ†±").tag(0)
                Text("Ë°ìÂæåÁµåÈÅé").tag(1)
                Text("üì∏ ÂÜôÁúü").tag(2)
            }
            .pickerStyle(.segmented)
            .padding()
            
            Divider()
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ
            TabView(selection: $selectedTab) {
                // ÊâãË°ìÊÉÖÂ†±„Çø„Éñ
                surgeryInfoTab
                    .tag(0)
                
                // Ë°ìÂæåÁµåÈÅé„Çø„Éñ
                followUpTab
                    .tag(1)
                
                // ÂÜôÁúü„Çø„Éñ
                PhotoManagementView(surgery: surgery)
                    .tag(2)
            }
            .tabViewStyle(.automatic)
        }
        .sheet(isPresented: $showEditSurgery) {
            EditSurgeryView(surgery: surgery)
        }
        .sheet(isPresented: $showAddFollowUp) {
            AddFollowUpView(surgery: surgery)
        }
    }
    
    private var surgeryInfoTab: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 20) {
                GroupBox(label: Label("Âü∫Êú¨ÊÉÖÂ†±", systemImage: "info.circle")) {
                    VStack(alignment: .leading, spacing: 10) {
                        InfoRow(label: "Ë°ìÂºè„Ç´„ÉÜ„Ç¥„É™", value: surgery.surgeryCategory ?? "‰∏çÊòé")
                        InfoRow(label: "Ë°ìÂºè", value: surgery.surgeryType ?? "‰∏çÊòé")
                        
                        if let date = surgery.surgeryDate {
                            InfoRow(label: "ÊâãË°ìÊó•", value: date.formatted(date: .long, time: .omitted))
                        }
                    }
                    .padding()
                }
                
                // ËÑÇËÇ™Ë±äËÉ∏„ÅÆÂõ∫ÊúâÊÉÖÂ†±
                if surgery.surgeryType == "ËÑÇËÇ™Ë±äËÉ∏" {
                    GroupBox(label: Label("ËÑÇËÇ™Ë±äËÉ∏ Ë©≥Á¥∞", systemImage: "heart.fill")) {
                        VStack(alignment: .leading, spacing: 10) {
                            InfoRow(label: "VASER‰ΩøÁî®", value: surgery.vaserUsed ? "„ÅÇ„Çä" : "„Å™„Åó")
                            InfoRow(label: "Aquicell‰ΩøÁî®", value: surgery.aquicellUsed ? "„ÅÇ„Çä" : "„Å™„Åó")
                            
                            if let donorSite = surgery.donorSite {
                                InfoRow(label: "Êé°ÂèñÈÉ®‰Ωç", value: donorSite)
                            }
                            
                            if let rightVol = surgery.rightBreastVolume {
                                InfoRow(label: "Âè≥ËÉ∏Ê≥®ÂÖ•Èáè", value: rightVol)
                            }
                            
                            if let leftVol = surgery.leftBreastVolume {
                                InfoRow(label: "Â∑¶ËÉ∏Ê≥®ÂÖ•Èáè", value: leftVol)
                            }
                        }
                        .padding()
                    }
                }
                
                // ÂÖ±ÈÄöÊÉÖÂ†±
                GroupBox(label: Label("„Åù„ÅÆ‰ªñ", systemImage: "note.text")) {
                    VStack(alignment: .leading, spacing: 10) {
                        InfoRow(label: "Ë°ìÂâçVectra", value: surgery.preOpVectra ? "ÂÆüÊñΩ" : "Êú™ÂÆüÊñΩ")
                        
                        if let skinLaxity = surgery.skinLaxity, !skinLaxity.isEmpty {
                            InfoRow(label: "ÁöÆËÜöÂºõÁ∑©Â∫¶", value: skinLaxity)
                        }
                        
                        if let notes = surgery.notes, !notes.isEmpty {
                            VStack(alignment: .leading, spacing: 5) {
                                Text("ÂÇôËÄÉ")
                                    .fontWeight(.semibold)
                                Text(notes)
                                    .foregroundColor(.secondary)
                            }
                        }
                    }
                    .padding()
                }
            }
            .padding()
        }
    }
    
    private var followUpTab: some View {
        VStack(spacing: 0) {
            HStack {
                Text("Ë°ìÂæåÁµåÈÅéË®òÈå≤")
                    .font(.headline)
                Spacer()
                Button(action: { showAddFollowUp = true }) {
                    Label("ÁµåÈÅé„ÇíËøΩÂä†", systemImage: "plus.circle.fill")
                }
                .buttonStyle(.borderedProminent)
            }
            .padding()
            
            Divider()
            
            if followUps.isEmpty {
                VStack(spacing: 20) {
                    Image(systemName: "calendar.badge.clock")
                        .font(.system(size: 60))
                        .foregroundColor(.gray)
                    Text("ÁµåÈÅéË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")
                        .font(.headline)
                        .foregroundColor(.secondary)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    VStack(spacing: 15) {
                        ForEach(followUps, id: \.self) { followUp in
                            FollowUpCardView(followUp: followUp)
                        }
                    }
                    .padding()
                }
            }
        }
    }
}

// MARK: - FollowUpCardView

struct FollowUpCardView: View {
    let followUp: FollowUp
    
    var body: some View {
        VStack(alignment: .leading, spacing: 10) {
            HStack {
                Text(followUp.timing ?? "‰∏çÊòé")
                    .font(.headline)
                    .fontWeight(.bold)
                
                Spacer()
                
                if let date = followUp.measurementDate {
                    Text(date, style: .date)
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            
            Divider()
            
            VStack(alignment: .leading, spacing: 8) {
                if followUp.vectraPerformed {
                    Label("VectraÊ∏¨ÂÆöÂÆüÊñΩ", systemImage: "checkmark.circle.fill")
                        .foregroundColor(.green)
                        .font(.caption)
                }
                
                if followUp.bodyWeight > 0 {
                    InfoRow(label: "‰ΩìÈáç", value: String(format: "%.1f kg", followUp.bodyWeight))
                        .font(.caption)
                }
                
                if let smoking = followUp.smokingStatus {
                    InfoRow(label: "Âñ´ÁÖô", value: smoking)
                        .font(.caption)
                }
                
                if followUp.breastQScore > 0 {
                    InfoRow(label: "Breast-Q", value: "\(followUp.breastQScore)ÁÇπ")
                        .font(.caption)
                }
            }
        }
        .padding()
        .background(Color(NSColor.controlBackgroundColor))
        .cornerRadius(12)
        .shadow(radius: 2)
    }
}

// MARK: - AddPatientView

struct AddPatientView: View {
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var name = ""
    @State private var age = ""
    @State private var gender = "Â•≥ÊÄß"
    @State private var contactInfo = ""
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("Êñ∞Ë¶èÊÇ£ËÄÖÁôªÈå≤")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                TextField("Ê∞èÂêç", text: $name)
                TextField("Âπ¥ÈΩ¢", text: $age)
                Picker("ÊÄßÂà•", selection: $gender) {
                    Text("Â•≥ÊÄß").tag("Â•≥ÊÄß")
                    Text("Áî∑ÊÄß").tag("Áî∑ÊÄß")
                }
                TextField("ÈÄ£Áµ°ÂÖà", text: $contactInfo)
            }
            .padding()
            
            Spacer()
            
            Button("ÁôªÈå≤") {
                savePatient()
            }
            .buttonStyle(.borderedProminent)
            .disabled(name.isEmpty || age.isEmpty)
            .padding()
        }
        .frame(width: 500, height: 400)
    }
    
    private func savePatient() {
        guard let ageInt = Int(age) else { return }
        
        _ = Persistence.shared.savePatient(
            context: viewContext,
            name: name,
            age: ageInt,
            gender: gender,
            contactInfo: contactInfo.isEmpty ? nil : contactInfo
        )
        
        dismiss()
    }
}

// MARK: - EditPatientView

struct EditPatientView: View {
    let patient: Patient
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var name: String
    @State private var age: String
    @State private var gender: String
    @State private var contactInfo: String
    
    init(patient: Patient) {
        self.patient = patient
        _name = State(initialValue: patient.name ?? "")
        _age = State(initialValue: String(patient.age))
        _gender = State(initialValue: patient.gender ?? "Â•≥ÊÄß")
        _contactInfo = State(initialValue: patient.contactInfo ?? "")
    }
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("ÊÇ£ËÄÖÊÉÖÂ†±Á∑®ÈõÜ")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                TextField("Ê∞èÂêç", text: $name)
                TextField("Âπ¥ÈΩ¢", text: $age)
                Picker("ÊÄßÂà•", selection: $gender) {
                    Text("Â•≥ÊÄß").tag("Â•≥ÊÄß")
                    Text("Áî∑ÊÄß").tag("Áî∑ÊÄß")
                }
                TextField("ÈÄ£Áµ°ÂÖà", text: $contactInfo)
            }
            .padding()
            
            Spacer()
            
            Button("‰øùÂ≠ò") {
                saveChanges()
            }
            .buttonStyle(.borderedProminent)
            .disabled(name.isEmpty || age.isEmpty)
            .padding()
        }
        .frame(width: 500, height: 400)
    }
    
    private func saveChanges() {
        guard let ageInt = Int(age) else { return }
        
        patient.name = name
        patient.age = Int16(ageInt)
        patient.gender = gender
        patient.contactInfo = contactInfo.isEmpty ? nil : contactInfo
        
        do {
            try viewContext.save()
            dismiss()
        } catch {
            print("‚ùå ‰øùÂ≠òÂ§±Êïó: \(error)")
        }
    }
}


// MARK: - AddSurgeryView

struct AddSurgeryView: View {
    let patient: Patient
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var surgeryDate = Date()
    @State private var selectedCategory: SurgeryCategory = .breastAugmentation
    @State private var selectedType: SurgeryType = .fatGraft
    @State private var vaserUsed = false
    @State private var aquicellUsed = false
    @State private var preOpVectra = false
    @State private var skinLaxity = ""
    @State private var donorSite = ""
    @State private var rightBreastVolume = ""
    @State private var leftBreastVolume = ""
    @State private var notes = ""
    
    var availableTypes: [SurgeryType] {
        SurgeryType.types(for: selectedCategory)
    }
    
    var body: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 20) {
                // „Éò„ÉÉ„ÉÄ„Éº
                HStack {
                    Text("ÊâãË°ìÁôªÈå≤")
                        .font(.title2)
                        .fontWeight(.bold)
                    Spacer()
                    Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
                }
                .padding()
                
                Divider()
                
                // Ë°ìÂºèÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥
                GroupBox(label: Label("Ë°ìÂºè", systemImage: "stethoscope")) {
                    VStack(alignment: .leading, spacing: 15) {
                        // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
                        VStack(alignment: .leading) {
                            Text("„Ç´„ÉÜ„Ç¥„É™")
                                .fontWeight(.semibold)
                            Picker("„Ç´„ÉÜ„Ç¥„É™", selection: $selectedCategory) {
                                ForEach(SurgeryCategory.allCases, id: \.self) { category in
                                    Text(category.displayName).tag(category)
                                }
                            }
                            .pickerStyle(.segmented)
                            .onChange(of: selectedCategory) { newCategory in
                                // „Ç´„ÉÜ„Ç¥„É™Â§âÊõ¥ÊôÇ„Å´Ë°ìÂºè„Çí„É™„Çª„ÉÉ„Éà
                                selectedType = SurgeryType.types(for: newCategory).first ?? .fatGraft
                            }
                        }
                        
                        Divider()
                        
                        // Ë°ìÂºèÈÅ∏Êäû
                        VStack(alignment: .leading) {
                            Text("Ë°ìÂºè")
                                .fontWeight(.semibold)
                            Picker("Ë°ìÂºè", selection: $selectedType) {
                                ForEach(availableTypes, id: \.self) { type in
                                    Text(type.displayName).tag(type)
                                }
                            }
                            .pickerStyle(.menu)
                        }
                    }
                    .padding()
                }
                
                // ÊâãË°ìÊó•
                GroupBox(label: Label("ÊâãË°ìÊó•", systemImage: "calendar")) {
                    DatePicker("", selection: $surgeryDate, displayedComponents: .date)
                        .datePickerStyle(.graphical)
                        .padding()
                }
                
                // Ë°ìÂºèÂõ∫Êúâ„Éï„Ç£„Éº„É´„ÉâÔºàÊù°‰ª∂Ë°®Á§∫Ôºâ
                if selectedCategory == .breastAugmentation {
                    breastAugmentationFields
                }
                
                // ÂÖ±ÈÄö„Éï„Ç£„Éº„É´„Éâ
                GroupBox(label: Label("ÂÖ±ÈÄöÈ†ÖÁõÆ", systemImage: "doc.text")) {
                    VStack(alignment: .leading, spacing: 15) {
                        Toggle("Ë°ìÂâçVectraÊíÆÂΩ±", isOn: $preOpVectra)
                        
                        TextField("ÁöÆËÜöÂºõÁ∑©Â∫¶", text: $skinLaxity)
                        
                        TextField("ÂÇôËÄÉ", text: $notes, axis: .vertical)
                            .lineLimit(3...6)
                    }
                    .padding()
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥
                Button(action: saveSurgery) {
                    Label("ÊâãË°ì„ÇíÁôªÈå≤", systemImage: "checkmark.circle.fill")
                        .frame(maxWidth: .infinity)
                }
                .buttonStyle(.borderedProminent)
                .padding()
            }
            .padding()
        }
        .frame(width: 600, height: 800)
    }
    
    // Ë±äËÉ∏ÊâãË°ì„ÅÆÂõ∫Êúâ„Éï„Ç£„Éº„É´„Éâ
    private var breastAugmentationFields: some View {
        GroupBox(label: Label("ÊâãË°ìË©≥Á¥∞", systemImage: "info.circle")) {
            VStack(alignment: .leading, spacing: 15) {
                // ËÑÇËÇ™Ë±äËÉ∏„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                if selectedType == .fatGraft {
                    VStack(alignment: .leading, spacing: 10) {
                        Text("VASER‰ΩøÁî®")
                            .fontWeight(.semibold)
                        Picker("VASER‰ΩøÁî®", selection: $vaserUsed) {
                            Text("„Å™„Åó").tag(false)
                            Text("„ÅÇ„Çä").tag(true)
                        }
                        .pickerStyle(.segmented)
                    }
                    
                    VStack(alignment: .leading, spacing: 10) {
                        Text("Aquicell‰ΩøÁî®")
                            .fontWeight(.semibold)
                        Picker("Aquicell‰ΩøÁî®", selection: $aquicellUsed) {
                            Text("„Å™„Åó").tag(false)
                            Text("„ÅÇ„Çä").tag(true)
                        }
                        .pickerStyle(.segmented)
                    }
                    
                    TextField("Êé°ÂèñÈÉ®‰Ωç", text: $donorSite)
                    
                    HStack {
                        TextField("Âè≥ËÉ∏Ê≥®ÂÖ•Èáè (ml)", text: $rightBreastVolume)
                        TextField("Â∑¶ËÉ∏Ê≥®ÂÖ•Èáè (ml)", text: $leftBreastVolume)
                    }
                }
                
                // „Ç∑„É™„Ç≥„É≥„Éê„ÉÉ„Ç∞„ÅÆÂ†¥ÂêàÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
                if selectedType == .siliconeImplant {
                    Text("„Ç∑„É™„Ç≥„É≥„Éê„ÉÉ„Ç∞Ë±äËÉ∏„ÅÆË©≥Á¥∞È†ÖÁõÆ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö")
                        .foregroundColor(.secondary)
                        .italic()
                        .padding()
                }
                
                // „Åù„ÅÆ‰ªñ„ÅÆË°ìÂºèÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
                if selectedCategory == .liposuction {
                    Text("ËÑÇËÇ™Âê∏Âºï„ÅÆË©≥Á¥∞È†ÖÁõÆ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö")
                        .foregroundColor(.secondary)
                        .italic()
                        .padding()
                }
                
                if selectedCategory == .upperEyelid || selectedCategory == .lowerEyelid {
                    Text("ÁúºÁûºÊâãË°ì„ÅÆË©≥Á¥∞È†ÖÁõÆ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö")
                        .foregroundColor(.secondary)
                        .italic()
                        .padding()
                }
            }
            .padding()
        }
    }
    
    private func saveSurgery() {
        Persistence.shared.saveSurgery(
            context: viewContext,
            patient: patient,
            surgeryDate: surgeryDate,
            surgeryCategory: selectedCategory.rawValue,
            surgeryType: selectedType.rawValue,
            vaserUsed: vaserUsed,
            aquicellUsed: aquicellUsed,
            preOpVectra: preOpVectra,
            skinLaxity: skinLaxity.isEmpty ? nil : skinLaxity,
            donorSite: donorSite.isEmpty ? nil : donorSite,
            rightBreastVolume: rightBreastVolume.isEmpty ? nil : rightBreastVolume,
            leftBreastVolume: leftBreastVolume.isEmpty ? nil : leftBreastVolume,
            notes: notes.isEmpty ? nil : notes
        )
        
        dismiss()
    }
}

// MARK: - EditSurgeryView

struct EditSurgeryView: View {
    let surgery: Surgery
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var surgeryDate: Date
    @State private var selectedCategory: SurgeryCategory
    @State private var selectedType: SurgeryType
    @State private var vaserUsed: Bool
    @State private var aquicellUsed: Bool
    @State private var preOpVectra: Bool
    @State private var skinLaxity: String
    @State private var donorSite: String
    @State private var rightBreastVolume: String
    @State private var leftBreastVolume: String
    @State private var notes: String
    
    init(surgery: Surgery) {
        self.surgery = surgery
        _surgeryDate = State(initialValue: surgery.surgeryDate ?? Date())
        _selectedCategory = State(initialValue: SurgeryCategory(rawValue: surgery.surgeryCategory ?? "Ë±äËÉ∏") ?? .breastAugmentation)
        _selectedType = State(initialValue: SurgeryType(rawValue: surgery.surgeryType ?? "ËÑÇËÇ™Ë±äËÉ∏") ?? .fatGraft)
        _vaserUsed = State(initialValue: surgery.vaserUsed)
        _aquicellUsed = State(initialValue: surgery.aquicellUsed)
        _preOpVectra = State(initialValue: surgery.preOpVectra)
        _skinLaxity = State(initialValue: surgery.skinLaxity ?? "")
        _donorSite = State(initialValue: surgery.donorSite ?? "")
        _rightBreastVolume = State(initialValue: surgery.rightBreastVolume ?? "")
        _leftBreastVolume = State(initialValue: surgery.leftBreastVolume ?? "")
        _notes = State(initialValue: surgery.notes ?? "")
    }
    
    var availableTypes: [SurgeryType] {
        SurgeryType.types(for: selectedCategory)
    }
    
    var body: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 20) {
                // „Éò„ÉÉ„ÉÄ„Éº
                HStack {
                    Text("ÊâãË°ìÊÉÖÂ†±Á∑®ÈõÜ")
                        .font(.title2)
                        .fontWeight(.bold)
                    Spacer()
                    Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
                }
                .padding()
                
                Divider()
                
                // Ë°ìÂºèÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥
                GroupBox(label: Label("Ë°ìÂºè", systemImage: "stethoscope")) {
                    VStack(alignment: .leading, spacing: 15) {
                        VStack(alignment: .leading) {
                            Text("„Ç´„ÉÜ„Ç¥„É™")
                                .fontWeight(.semibold)
                            Picker("„Ç´„ÉÜ„Ç¥„É™", selection: $selectedCategory) {
                                ForEach(SurgeryCategory.allCases, id: \.self) { category in
                                    Text(category.displayName).tag(category)
                                }
                            }
                            .pickerStyle(.segmented)
                            .onChange(of: selectedCategory) { newCategory in
                                selectedType = SurgeryType.types(for: newCategory).first ?? .fatGraft
                            }
                        }
                        
                        Divider()
                        
                        VStack(alignment: .leading) {
                            Text("Ë°ìÂºè")
                                .fontWeight(.semibold)
                            Picker("Ë°ìÂºè", selection: $selectedType) {
                                ForEach(availableTypes, id: \.self) { type in
                                    Text(type.displayName).tag(type)
                                }
                            }
                            .pickerStyle(.menu)
                        }
                    }
                    .padding()
                }
                
                // ÊâãË°ìÊó•
                GroupBox(label: Label("ÊâãË°ìÊó•", systemImage: "calendar")) {
                    DatePicker("", selection: $surgeryDate, displayedComponents: .date)
                        .datePickerStyle(.graphical)
                        .padding()
                }
                
                // Ë°ìÂºèÂõ∫Êúâ„Éï„Ç£„Éº„É´„Éâ
                if selectedCategory == .breastAugmentation && selectedType == .fatGraft {
                    GroupBox(label: Label("ËÑÇËÇ™Ë±äËÉ∏ Ë©≥Á¥∞", systemImage: "info.circle")) {
                        VStack(alignment: .leading, spacing: 15) {
                            VStack(alignment: .leading, spacing: 10) {
                                Text("VASER‰ΩøÁî®")
                                    .fontWeight(.semibold)
                                Picker("VASER‰ΩøÁî®", selection: $vaserUsed) {
                                    Text("„Å™„Åó").tag(false)
                                    Text("„ÅÇ„Çä").tag(true)
                                }
                                .pickerStyle(.segmented)
                            }
                            
                            VStack(alignment: .leading, spacing: 10) {
                                Text("Aquicell‰ΩøÁî®")
                                    .fontWeight(.semibold)
                                Picker("Aquicell‰ΩøÁî®", selection: $aquicellUsed) {
                                    Text("„Å™„Åó").tag(false)
                                    Text("„ÅÇ„Çä").tag(true)
                                }
                                .pickerStyle(.segmented)
                            }
                            
                            TextField("Êé°ÂèñÈÉ®‰Ωç", text: $donorSite)
                            
                            HStack {
                                TextField("Âè≥ËÉ∏Ê≥®ÂÖ•Èáè (ml)", text: $rightBreastVolume)
                                TextField("Â∑¶ËÉ∏Ê≥®ÂÖ•Èáè (ml)", text: $leftBreastVolume)
                            }
                        }
                        .padding()
                    }
                }
                
                // ÂÖ±ÈÄö„Éï„Ç£„Éº„É´„Éâ
                GroupBox(label: Label("ÂÖ±ÈÄöÈ†ÖÁõÆ", systemImage: "doc.text")) {
                    VStack(alignment: .leading, spacing: 15) {
                        Toggle("Ë°ìÂâçVectraÊíÆÂΩ±", isOn: $preOpVectra)
                        
                        TextField("ÁöÆËÜöÂºõÁ∑©Â∫¶", text: $skinLaxity)
                        
                        TextField("ÂÇôËÄÉ", text: $notes, axis: .vertical)
                            .lineLimit(3...6)
                    }
                    .padding()
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥
                Button(action: saveChanges) {
                    Label("Â§âÊõ¥„Çí‰øùÂ≠ò", systemImage: "checkmark.circle.fill")
                        .frame(maxWidth: .infinity)
                }
                .buttonStyle(.borderedProminent)
                .padding()
            }
            .padding()
        }
        .frame(width: 600, height: 800)
    }
    
    private func saveChanges() {
        surgery.surgeryDate = surgeryDate
        surgery.surgeryCategory = selectedCategory.rawValue
        surgery.surgeryType = selectedType.rawValue
        surgery.vaserUsed = vaserUsed
        surgery.aquicellUsed = aquicellUsed
        surgery.preOpVectra = preOpVectra
        surgery.skinLaxity = skinLaxity.isEmpty ? nil : skinLaxity
        surgery.donorSite = donorSite.isEmpty ? nil : donorSite
        surgery.rightBreastVolume = rightBreastVolume.isEmpty ? nil : rightBreastVolume
        surgery.leftBreastVolume = leftBreastVolume.isEmpty ? nil : leftBreastVolume
        surgery.notes = notes.isEmpty ? nil : notes
        
        do {
            try viewContext.save()
            dismiss()
        } catch {
            print("‚ùå ‰øùÂ≠òÂ§±Êïó: \(error)")
        }
    }
}

// MARK: - AddFollowUpView

struct AddFollowUpView: View {
    let surgery: Surgery
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var timing = "1W"
    @State private var measurementDate = Date()
    @State private var vectraPerformed = false
    @State private var bodyWeight = ""
    @State private var smokingStatus = "„Å™„Åó"
    @State private var breastQScore = ""
    @State private var notes = ""
    
    let timings = ["1W", "1M", "3M", "6M", "12M"]
    let smokingOptions = ["„Å™„Åó", "„ÅÇ„ÇäÔºàÁ∂ôÁ∂öÔºâ", "Á¶ÅÁÖô‰∏≠"]
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("Ë°ìÂæåÁµåÈÅéËøΩÂä†")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                Picker("Ê∏¨ÂÆöÊôÇÊúü", selection: $timing) {
                    ForEach(timings, id: \.self) { t in
                        Text(t).tag(t)
                    }
                }
                
                DatePicker("Ê∏¨ÂÆöÊó•", selection: $measurementDate, displayedComponents: .date)
                
                Toggle("VectraÊ∏¨ÂÆö", isOn: $vectraPerformed)
                
                TextField("‰ΩìÈáç (kg)", text: $bodyWeight)
                
                Picker("Âñ´ÁÖôÁä∂Ê≥Å", selection: $smokingStatus) {
                    ForEach(smokingOptions, id: \.self) { option in
                        Text(option).tag(option)
                    }
                }
                
                TextField("Breast-Q„Çπ„Ç≥„Ç¢", text: $breastQScore)
                
                TextField("ÂÇôËÄÉ", text: $notes, axis: .vertical)
                    .lineLimit(3...6)
            }
            .padding()
            
            Spacer()
            
            Button("‰øùÂ≠ò") {
                saveFollowUp()
            }
            .buttonStyle(.borderedProminent)
            .padding()
        }
        .frame(width: 550, height: 550)
    }
    
    private func saveFollowUp() {
        Persistence.shared.saveFollowUp(
            context: viewContext,
            surgery: surgery,
            timing: timing,
            measurementDate: measurementDate,
            vectraPerformed: vectraPerformed,
            bodyWeight: Double(bodyWeight),
            smokingStatus: smokingStatus,
            breastQScore: Int(breastQScore),
            notes: notes.isEmpty ? nil : notes
        )
        
        dismiss()
    }
}

// MARK: - EditFollowUpView

struct EditFollowUpView: View {
    let followUp: FollowUp
    @Environment(\.managedObjectContext) private var viewContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var timing: String
    @State private var measurementDate: Date
    @State private var vectraPerformed: Bool
    @State private var bodyWeight: String
    @State private var smokingStatus: String
    @State private var breastQScore: String
    @State private var notes: String
    
    let timings = ["1W", "1M", "3M", "6M", "12M"]
    let smokingOptions = ["„Å™„Åó", "„ÅÇ„ÇäÔºàÁ∂ôÁ∂öÔºâ", "Á¶ÅÁÖô‰∏≠"]
    
    init(followUp: FollowUp) {
        self.followUp = followUp
        _timing = State(initialValue: followUp.timing ?? "1M")
        _measurementDate = State(initialValue: followUp.measurementDate ?? Date())
        _vectraPerformed = State(initialValue: followUp.vectraPerformed)
        _bodyWeight = State(initialValue: followUp.bodyWeight > 0 ? String(followUp.bodyWeight) : "")
        _smokingStatus = State(initialValue: followUp.smokingStatus ?? "„Å™„Åó")
        _breastQScore = State(initialValue: followUp.breastQScore > 0 ? String(followUp.breastQScore) : "")
        _notes = State(initialValue: followUp.notes ?? "")
    }
    
    var body: some View {
        VStack(spacing: 20) {
            HStack {
                Text("Ë°ìÂæåÁµåÈÅéÁ∑®ÈõÜ")
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
                Button("„Ç≠„É£„É≥„Çª„É´") { dismiss() }
            }
            .padding()
            
            Divider()
            
            Form {
                Picker("Ê∏¨ÂÆöÊôÇÊúü", selection: $timing) {
                    ForEach(timings, id: \.self) { t in
                        Text(t).tag(t)
                    }
                }
                
                DatePicker("Ê∏¨ÂÆöÊó•", selection: $measurementDate, displayedComponents: .date)
                
                Toggle("VectraÊ∏¨ÂÆö", isOn: $vectraPerformed)
                
                TextField("‰ΩìÈáç (kg)", text: $bodyWeight)
                
                Picker("Âñ´ÁÖôÁä∂Ê≥Å", selection: $smokingStatus) {
                    ForEach(smokingOptions, id: \.self) { option in
                        Text(option).tag(option)
                    }
                }
                
                TextField("Breast-Q„Çπ„Ç≥„Ç¢", text: $breastQScore)
                
                TextField("ÂÇôËÄÉ", text: $notes, axis: .vertical)
                    .lineLimit(3...6)
            }
            .padding()
            
            Spacer()
            
            Button("‰øùÂ≠ò") {
                saveChanges()
            }
            .buttonStyle(.borderedProminent)
            .padding()
        }
        .frame(width: 550, height: 600)
    }
    
    private func saveChanges() {
        followUp.timing = timing
        followUp.measurementDate = measurementDate
        followUp.vectraPerformed = vectraPerformed
        followUp.bodyWeight = Double(bodyWeight) ?? 0
        followUp.smokingStatus = smokingStatus
        followUp.breastQScore = Int16(Int(breastQScore) ?? 0)
        followUp.notes = notes.isEmpty ? nil : notes
        
        do {
            try viewContext.save()
            dismiss()
        } catch {
            print("‚ùå ‰øùÂ≠òÂ§±Êïó: \(error)")
        }
    }
}

// MARK: - ToastView

struct ToastView: View {
    let message: String
    @Binding var isShowing: Bool
    
    var body: some View {
        VStack {
            Text(message)
                .padding()
                .background(Color.black.opacity(0.8))
                .foregroundColor(.white)
                .cornerRadius(8)
                .padding(.top, 50)
            Spacer()
        }
        .transition(.move(edge: .top).combined(with: .opacity))
    }
}

